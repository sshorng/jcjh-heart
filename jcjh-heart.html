<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å»ºæˆå¿ƒèƒ½é‡</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700&family=Noto+Sans+TC:wght@400;500;700&family=Noto+Color+Emoji&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- SweetAlert2 & Marked.js -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root {
            --primary-coral: #e66767;
            /* åŠ æ·±çŠç‘šç´… */
            --soft-cream: #fcebe6;
            /* å†æ¬¡åŠ æ·±èƒŒæ™¯åŸºæº–è‰² */
            --glass-bg: rgba(255, 255, 255, 0.65);
            --glass-border: rgba(255, 255, 255, 0.4);
            --font-main: 'Apple Color Emoji', 'Segoe UI Emoji', 'Noto Color Emoji', 'Outfit', 'Noto Sans TC', sans-serif;
            /* æ•ˆèƒ½å„ªåŒ–ï¼šç²¾ç°¡é™°å½±æ¸²æŸ“è² æ“” */
            --card-shadow: 0 8px 25px rgba(107, 79, 79, 0.12);
        }


        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: var(--font-main);
        }

        body {
            font-family: 'Apple Color Emoji', 'Segoe UI Emoji', 'Noto Color Emoji', 'Outfit', 'Noto Sans TC', 'Segoe UI Symbol', sans-serif;
            background: #fff5f2;
            color: #4a3e3e;
            margin: 0;
            padding: 0;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
        }

        /* å·”å³°è³ªæ„Ÿï¼šæµé«”å‹•æ…‹æ¼¸å±¤èƒŒæ™¯ */
        .ambient-glow {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--soft-cream);
            /* åŠ å…¥æ¥µè–„çš„é¡†ç²’æ„Ÿç´‹ç†ï¼Œæ‰“ç ´å¤§è¢å¹•çš„ç³ŠåŒ–æ„Ÿ */
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
            background-blend-mode: soft-light;
            opacity: 0.96;
            z-index: -1;
            overflow: hidden;
        }

        .ambient-glow::before,
        .ambient-glow::after {
            content: '';
            position: absolute;
            width: 80vmax;
            height: 80vmax;
            border-radius: 50%;
            filter: blur(60px);
            opacity: 0.35;
            /* å†æ¬¡æé«˜å…‰æšˆä¸é€æ˜åº¦ */
            z-index: -1;
            animation: drift 25s infinite alternate ease-in-out;
        }

        .ambient-glow::before {
            background: radial-gradient(circle, #ff6b6b 0%, transparent 70%);
            /* åŠ æ·±å…‰æšˆé¡è‰² */
            top: -20%;
            left: -10%;
        }

        .ambient-glow::after {
            background: radial-gradient(circle, #f08a8a 0%, transparent 70%);
            /* åŠ æ·±å…‰æšˆé¡è‰² */
            bottom: -20%;
            right: -10%;
            animation-duration: 35s;
            animation-delay: -5s;
        }

        @keyframes drift {
            0% {
                transform: translate(0, 0) scale(1) rotate(0deg);
            }

            50% {
                transform: translate(10%, 15%) scale(1.1) rotate(10deg);
            }

            100% {
                transform: translate(-5%, -10%) scale(1) rotate(-5deg);
            }
        }

        /* --- ç²’å­ç‰¹æ•ˆç³»çµ± --- */
        /* ç²’å­ç‰¹æ•ˆç‰¹æ•ˆé£›èˆç¯„åœä¸å—é™ */
        .particle {
            position: absolute;
            pointer-events: none;
            will-change: transform, opacity;
            z-index: 10000;
            /* é«˜æ–¼ä¸€åˆ‡ */
            font-family: 'Apple Color Emoji', 'Segoe UI Emoji', 'Noto Color Emoji', 'Segoe UI Symbol', serif;
        }

        /* å–æ¶ˆé—œéµå­—é«˜äº®æ¨£å¼
        .keyword-highlight { ... } 
        */

        @keyframes floatUp {
            0% {
                transform: translateY(0) rotate(0deg);
                opacity: 0;
            }

            10% {
                opacity: 1;
            }

            100% {
                transform: translateY(-100px) rotate(360deg);
                opacity: 0;
            }
        }

        @keyframes rainDown {
            0% {
                transform: translateY(-20px) rotate(0deg);
                opacity: 0;
            }

            10% {
                opacity: 1;
            }

            100% {
                transform: translateY(200px) rotate(180deg);
                opacity: 0;
            }
        }

        @keyframes burstOut {
            0% {
                transform: translate(0, 0) scale(0.5);
                opacity: 1;
            }

            100% {
                transform: translate(var(--tx), var(--ty)) scale(1.2) rotate(var(--rot));
                opacity: 0;
            }
        }

        @keyframes spiralIn {
            0% {
                transform: translate(0, 0) scale(0.2) rotate(0deg);
                opacity: 0;
            }

            50% {
                opacity: 1;
            }

            100% {
                transform: translate(var(--tx), var(--ty)) scale(1.5) rotate(720deg);
                opacity: 0;
            }
        }

        @keyframes fireworkUp {
            0% {
                transform: translateY(0) scale(1);
                opacity: 1;
            }

            50% {
                transform: translateY(-150px) scale(1);
                opacity: 1;
            }

            100% {
                transform: translateY(-180px) scale(0);
                opacity: 0;
            }
        }

        @keyframes sparkleAnim {

            0%,
            100% {
                transform: scale(0) rotate(0deg);
                opacity: 0;
            }

            50% {
                transform: scale(1.2) rotate(45deg);
                opacity: 1;
            }
        }

        @keyframes explode {
            0% {
                transform: translate(0, 0) scale(1);
                opacity: 1;
            }

            100% {
                transform: translate(var(--ex), var(--ey)) scale(0);
                opacity: 0;
            }
        }

        /* â„ï¸ é£„é›ª/è½è‘‰æ¨¡å¼ */
        @keyframes snowFall {
            0% {
                transform: translate(0, -10px) rotate(0deg);
                opacity: 0;
            }

            10% {
                opacity: 1;
            }

            90% {
                opacity: 1;
            }

            100% {
                transform: translate(var(--sway), 100vh) rotate(var(--rot));
                opacity: 0;
            }
        }

        /* ğŸ€ å½ˆè·³æ¨¡å¼ */
        @keyframes bounceAnim {

            0%,
            20%,
            50%,
            80%,
            100% {
                transform: translateY(0);
            }

            40% {
                transform: translateY(-30px);
            }

            60% {
                transform: translateY(-15px);
            }
        }

        /* ğŸ’“ è„ˆå‹•æ¨¡å¼ */
        @keyframes pulseHeart {
            0% {
                transform: scale(1);
                opacity: 0.8;
            }

            50% {
                transform: scale(1.5);
                opacity: 1;
            }

            100% {
                transform: scale(1);
                opacity: 0.8;
            }
        }

        header {
            /* ç§»é™¤å¯èƒ½å¹²æ“¾å›ºå®šå®šä½æ¨™èªŒçš„é‚Šè· */
            z-index: 300;
            position: relative;
        }

        .header-bar {
            position: fixed;
            top: 46px;
            /* 36px è·‘é¦¬ç‡ˆ + 10px ç·Šæ¹Šç•™ç™½ */
            left: 1.5rem;
            z-index: 2000;
            background: rgba(255, 255, 255, 0.4);
            /* ä½¿ç”¨è³ªæ„Ÿæ›´ä½³çš„ 0.4 é€æ˜åº¦ */
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            padding: 0.8rem 1.8rem;
            border-radius: 40px;
            border: 1px solid var(--glass-border);
            display: flex;
            align-items: center;
            gap: 1.2rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.03);
            transition: all 0.3s ease;
        }

        .logo-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #f27979 0%, #ffb3b3 100%);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
            box-shadow: 0 8px 20px rgba(242, 121, 121, 0.3);
        }

        .logo-text h1 {
            font-size: 1.2rem;
            font-weight: 700;
            margin: 0;
            letter-spacing: 1px;
            color: var(--primary-coral);
        }

        .logo-text p {
            font-size: 0.75rem;
            margin: 0;
            opacity: 0.6;
        }

        /* é ‚éƒ¨è·‘é¦¬ç‡ˆå…¬å‘Š - æ¥µè‡´ç´”æ·¨ç‰ˆ */
        .ticker-wrapper {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 36px;
            /* èª¿æ•´è‡³ 36pxï¼Œç¸®æ¸›å‚ç›´ç•™ç™½ï¼Œè¦–è¦ºæ›´ç·Šå¯¦ */
            background: linear-gradient(90deg, rgba(230, 103, 103, 0.9) 0%, rgba(242, 121, 121, 0.85) 100%);
            backdrop-filter: blur(15px);
            z-index: 1100;
            display: flex;
            align-items: center;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.03);
            border: none;
            /* ç§»é™¤ä»»ä½•å¯èƒ½éœ²å‡ºçš„é‚Šç·š */
        }

        .ticker-content {
            display: flex;
            white-space: nowrap;
            padding-left: 100%;
            animation: marquee 40s linear infinite;
            /* é è¨­æ›´æ…¢çš„é€Ÿåº¦ */
            color: white;
            font-weight: 500;
            font-size: 1.1rem;
            /* å¾®èª¿ï¼šæ¸…æ™°ä½†ä¸å¤§æ–¼ä¸»æ¨™é¡Œ (1.2rem) */
            letter-spacing: 0.8px;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        .ticker-item {
            padding: 0 30vw;
            /* æ¥µå¤§é–“è·ï¼Œç‡Ÿé€ é«˜ç«¯å„ªé›…çš„å–®å‰‡æ»¾å‹•æ„Ÿ */
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .ticker-item i {
            font-size: 0.8rem;
            opacity: 0.8;
        }

        @keyframes marquee {
            0% {
                transform: translateX(0);
            }

            100% {
                transform: translateX(-100%);
            }
        }

        .header-actions {
            display: none;
        }

        .header-actions {
            display: none;
        }

        /* æ•´åˆå¼åŠŸèƒ½å€çµ„ä»¶ */
        .fab-container {
            position: fixed;
            bottom: 2.5rem;
            right: 2.5rem;
            z-index: 50;
            /* èª¿ä½ z-index è®“å¡ç‰‡èƒ½é®æ“‹ */
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .fab-qr-wrapper {
            background: rgba(255, 255, 255, 0.45);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            background: white;
            /* ç¢ºä¿èƒŒæ™¯ç´”ç™½æå‡å°æ¯” */
            padding: 10px;
            border-radius: 20px;
            border: 1px solid var(--primary-coral);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .fab-qr-wrapper:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.7);
        }

        .fab-qr-img {
            width: 110px;
            height: 110px;
            display: block;
            border-radius: 8px;
            /* ç§»é™¤å¯èƒ½é™ä½å°æ¯”åº¦çš„è¦–è¦ºæ•ˆæœ */
        }

        .admin-entry button {
            background: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid var(--glass-border);
            border-radius: 50%;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            color: #636e72;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        }

        .admin-entry button:hover {
            background: rgba(255, 255, 255, 0.6);
            color: var(--primary-coral);
            transform: translateY(-2px);
        }

        /* ç•™è¨€å±•ç¤ºå€ */
        #messageBoard {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 200;
            /* é«˜æ–¼æŒ‰éˆ•ï¼Œè®“å¡ç‰‡èƒ½é®æ“‹åŠŸèƒ½å€ */
            pointer-events: none;
        }

        /* é ‚ç´šè³ªæ„Ÿï¼šé«˜ç´šç´™è³ªèˆ‡ç´™è† å¸¶å¡ç‰‡ */
        .message-card {
            background: #fffdf9;
            background-image:
                radial-gradient(#e5e5e5 0.5px, transparent 0.5px),
                linear-gradient(rgba(255, 255, 255, 0.8), rgba(255, 255, 255, 0.2));
            background-size: 20px 20px, 100% 100%;
            border-radius: 12px;
            padding: 2.22rem;
            padding-top: 3.0rem;
            /* ç¸®å°é ‚éƒ¨è·é›¢ï¼Œè®“ã€Œè‡´ï¼šã€å¾€ä¸Šç§» */
            width: 340px;
            height: 260px;
            /* å›ºå®šé«˜åº¦ï¼Œä¸å†éš¨å…§å®¹å¢é•· */
            overflow: visible;
            /* æ¢å¾©å¯è¦‹ï¼Œé¿å…è£åˆ‡æ‰è² å®šä½çš„ç´™è† å¸¶ */
            box-shadow: var(--card-shadow);
            position: absolute;
            display: flex;
            flex-direction: column;
            gap: 0.4rem;
            /* ç¸®å°é–“è·ï¼Œè®“å…§å®¹å€æ›´å¤§ */
            will-change: transform, opacity;
            transform: translateZ(0);
            backface-visibility: hidden;
            perspective: 1000px;
            transition: all 0.6s cubic-bezier(0.23, 1, 0.32, 1);
            border: 1px solid #e8d5d5;
            /* åŠ å…¥å¯¦é«”ç´°é‚Šæ¡†ï¼Œç¢ºä¿åœ¨ä»»ä½•è¢å¹•çš†æ¸…æ™° */
            z-index: 100;
            /* é«˜æ–¼æŒ‰éˆ•å€åŸŸ */
            pointer-events: none;
        }

        /* é«˜å“è³ªå’Œç´™è† å¸¶ - æ•´é½Šåˆ‡é‚Š */
        .message-card::before {
            content: '';
            position: absolute;
            top: -12px;
            left: 50%;
            transform: translateX(-50%) rotate(0.5deg);
            width: 100px;
            height: 32px;
            background: rgba(255, 220, 180, 0.5);
            backdrop-filter: blur(4px);
            z-index: 5;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
            /* å’Œç´™çº–ç¶­ç´‹ç† */
            background-image:
                linear-gradient(90deg, rgba(255, 255, 255, 0.1) 1px, transparent 1px),
                linear-gradient(rgba(255, 255, 255, 0.1) 1px, transparent 1px);
            background-size: 4px 4px;
        }

        /* è¡Œæ”¿é‡˜é¸å…¬å‘Šå°ˆç”¨æ¨£å¼ - è¼•é‡åŒ–èˆ‡é‡‘é‡‘è‰²ç³» */
        .message-card.pinned-card {
            background: #fffcf0;
            border: 2px solid #f1c40f;
            box-shadow: 0 15px 45px rgba(241, 196, 15, 0.12);
            width: 280px;
            /* å¯¬åº¦ç¸®å° */
            min-height: 140px;
            /* é«˜åº¦èª¿é™ */
            padding-bottom: 1.5rem;
            /* åº•éƒ¨ç¨å¾®æ”¶ç·Š */
            gap: 0.8rem;
            /* å…§éƒ¨é–“è·æ”¶ç·Š */
        }

        /* å…¬å‘Šå…§å®¹å­—é«”å¼·åˆ¶ç¸®å° */
        .message-card.pinned-card .card-content {
            --font-size: 0.95rem;
            /* é è¨­ä½¿ç”¨è¼ƒå°å­—é«” */
            padding: 5px 0;
        }

        .message-card.pinned-card::before {
            background: rgba(241, 196, 15, 0.6);
            width: 120px;
            height: 35px;
            box-shadow: 0 2px 8px rgba(241, 196, 15, 0.2);
        }

        .badge-pinned {
            background: #f1c40f !important;
            color: #7f6000 !important;
            animation: pulse-gold 2s infinite;
        }

        @keyframes pulse-gold {
            0% {
                box-shadow: 0 0 0 0 rgba(241, 196, 15, 0.4);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(241, 196, 15, 0);
            }

            100% {}
        }

        /* æ‰‹ç¹ªæ„Ÿéƒµæˆ³è£é£¾ */
        .card-stamp {
            position: absolute;
            top: 1.5rem;
            right: 1.5rem;
            width: 70px;
            height: 70px;
            border: 2px solid rgba(186, 73, 73, 0.45);
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transform: rotate(var(--stamp-rot, -5deg));
            pointer-events: none;
            user-select: none;
            z-index: 5;
        }

        .card-stamp::after {
            content: '';
            position: absolute;
            width: 82%;
            height: 82%;
            border: 1px dashed rgba(186, 73, 73, 0.4);
            border-radius: 50%;
        }

        .stamp-date {
            font-size: 0.85rem;
            font-weight: 800;
            color: rgba(186, 73, 73, 0.65);
            line-height: 1;
            font-family: 'Courier New', Courier, monospace;
        }

        .stamp-label {
            font-size: 0.6rem;
            font-weight: 700;
            color: rgba(186, 73, 73, 0.55);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 2px;
            max-width: 58px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }



        /* æ¨™é¡Œæ•´åˆæ–¼ç´™å¼µä¸­ */
        .card-greeting {
            color: #b07d62;
            font-size: 1rem;
            font-weight: 700;
            padding-bottom: 4px;
            /* å†æ¬¡ç¸®å°ï¼Œé¨°å‡ºç©ºé–“çµ¦å…§å®¹ */
            border-bottom: 1.5px solid rgba(176, 125, 98, 0.15);
            width: fit-content;
        }

        /* æ–°å¢å…§å®¹å®¹å™¨ï¼Œä½”æ“šå‰©é¤˜ç©ºé–“ï¼Œç¢ºä¿ footer å›ºå®š */
        .card-body {
            flex: 1;
            min-height: 0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            /* é˜²æ­¢å…§å®¹æº¢å‡º */
            position: relative;
        }

        .card-content {
            font-size: var(--font-size, 1.4rem);
            line-height: 1.5;
            font-weight: 400;
            color: #4a3e3e;
            flex: 1;
            /* ä½”æ“š card-body çš„å‰©é¤˜ç©ºé–“ */
            min-height: 0;
            padding: 0;
            /* ç§»é™¤ä¸Šä¸‹ paddingï¼Œè®“ flex å®Œå…¨ç½®ä¸­ */
            word-break: break-all;
            /* overflow ç”± card-body æ§åˆ¶ */
            overflow: visible;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            /* å‚ç›´ç½®ä¸­ (Flex Direction ç‚º Column æ™‚) */
            align-items: center;
            /* æ°´å¹³ç½®ä¸­ */
            position: relative;
        }

        /* ç•¶æœ‰æ›è¡Œæ™‚ï¼šæ”¹ç‚ºé å·¦ï¼Œä½†ä»ç„¶å‚ç›´ç½®ä¸­ */
        .card-content.has-newline {
            text-align: left;
            align-items: flex-start;
            justify-content: center;
            /* æ”¹å›ç½®ä¸­ï¼Œç¢ºä¿çŸ­çš„å¤šè¡Œæ–‡æœ¬ä¹Ÿèƒ½å±…ä¸­ */
        }

        /* Markdown æ¨™ç±¤å¾®ä¿® */
        .card-content p {
            margin: 0 0 0.4em 0;
            width: 100%;
            line-height: inherit;
        }

        .card-content p:last-child {
            margin-bottom: 0;
        }

        .card-content ul,
        .card-content ol {
            padding-left: 1.2rem;
            margin: 0.2rem 0;
            text-align: left;
            width: 100%;
        }

        .card-content strong {
            color: var(--primary-coral);
        }

        /* éš±è—åŸç”Ÿæ»¾å‹•æ¢ï¼Œæ”¹ç”¨æ¥µç´°ç¾åŒ–ç‰ˆ */
        .card-content::-webkit-scrollbar {
            width: 3px;
        }

        .card-content::-webkit-scrollbar-thumb {
            background: rgba(176, 125, 98, 0.2);
            border-radius: 10px;
        }

        /* å­—ç´šç¸®æ”¾é¡åˆ¥ - é‡å° 60 å­—é™åˆ¶å„ªåŒ– */
        .size-large {
            --font-size: 1.3rem;
        }

        .size-medium {
            --font-size: 1.15rem;
        }

        .size-small {
            --font-size: 1.0rem;
        }

        .size-mini {
            --font-size: 0.85rem;
        }

        .card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 1px solid rgba(0, 0, 0, 0.05);
            padding-top: 1.2rem;
            flex-shrink: 0;
            /* é—œéµï¼šé˜²æ­¢åº•éƒ¨è¢«å£“ç¸®æˆ–æ¨æ“  */
            margin-top: auto;
            /* ç¢ºä¿æ°¸é è²¼åº• */
        }

        .card-author {
            color: #636e72;
            font-size: 0.85rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .card-tag {
            font-size: 0.75rem;
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        /* è«è˜­è¿ªå’Œè«§è‰²æ¨™ç±¤ */
        .card-tag {
            font-size: 0.75rem;
            padding: 5px 14px;
            border-radius: 8px;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        .tag-é¼“å‹µ {
            background: #d4e2d4;
            color: #4a7c59;
        }

        .tag-è®šç¾ {
            background: #f0e4d7;
            color: #b08968;
        }

        .tag-é—œå¿ƒ {
            background: #e3d5ca;
            color: #7f5539;
        }

        .tag-æ„Ÿè¬ {
            background: #dfd3c3;
            color: #8d7b70;
        }

        .tag-ç¥ç¦ {
            background: #f5ebe0;
            color: #d4a373;
        }

        /* æ‡¸æµ®æŒ‰éˆ•åŸå§‹ä½ç½® CSS å·²ç”± .fab-container æ¥ç®¡ */

        .fab {
            background: linear-gradient(135deg, #f27979 0%, #faa6a6 100%);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 30px;
            font-weight: 700;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 0.8rem;
            cursor: pointer;
            box-shadow: 0 15px 35px rgba(242, 121, 121, 0.3);
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .ticker-item {
            white-space: nowrap;
            padding: 0 4rem;
            color: white;
            font-weight: 500;
            font-size: 1.05rem;
            display: flex;
            align-items: center;
            gap: 12px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            backface-visibility: hidden;
            transform: translateZ(0);
        }

        .btn-write-fab {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: linear-gradient(135deg, #f27979 0%, #faa6a6 100%);
            color: white;
            padding: 1rem 2rem;
            border-radius: 30px;
            text-decoration: none;
            box-shadow: 0 15px 35px rgba(242, 121, 121, 0.3);
            display: flex;
            align-items: center;
            gap: 0.8rem;
            font-weight: 700;
            font-size: 1.1rem;
            z-index: 100;
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            border: none;
            cursor: pointer;
        }

        .btn-write-fab:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 20px 45px rgba(255, 138, 113, 0.5);
        }

        /* åˆ†äº«å¯«ç•™è¨€ä½ˆç½® */
        .fab-wrapper {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 1rem;
        }

        .fab:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 20px 45px rgba(212, 163, 115, 0.5);
        }

        .fab i {
            font-size: 1rem;
        }

        .fab-button-group {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .fab-secondary {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            color: #d4a373;
            border: 2px solid #d4a373;
            padding: 1rem;
            border-radius: 50%;
            width: 56px;
            height: 56px;
            box-shadow: 0 8px 25px rgba(242, 121, 121, 0.15);
        }

        .fab-secondary:hover {
            background: var(--primary-coral);
            color: white;
            transform: translateY(-3px) scale(1.05);
        }

        .fab-secondary.active {
            background: var(--primary-coral);
            color: white;
        }

        .pulsate {
            animation: pulsate 1.5s infinite;
        }

        @keyframes pulsate {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }

            100% {
                transform: scale(1);
            }
        }

        /* å‹•ç•«æ•ˆæœ */
        @keyframes fadeIn {
            0% {
                opacity: 0;
                transform: rotate(var(--rot, 0deg)) translateY(20px) scale(0.95) translateZ(0);
            }

            100% {
                opacity: 1;
                transform: rotate(var(--rot, 0deg)) translateY(0) scale(1) translateZ(0);
            }
        }

        @keyframes fadeOut {
            0% {
                opacity: 1;
                transform: rotate(var(--rot, 0deg)) translateZ(0);
            }

            100% {
                opacity: 0;
                transform: rotate(var(--rot, 0deg)) translateY(-15px) scale(0.95) translateZ(0);
            }
        }

        .animate-float {
            animation: fadeIn 0.6s ease-out forwards;
        }

        .animate-float.fade-out {
            animation: fadeOut 0.8s ease-out forwards;
        }


        .admin-trigger {
            position: fixed;
            bottom: 5px;
            right: 5px;
            width: 20px;
            height: 20px;
            opacity: 0.05;
            cursor: pointer;
            z-index: 400;
        }

        .admin-trigger:hover {
            opacity: 0.3;
        }

        /* Modal è¦†è“‹å±¤ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(107, 79, 79, 0.3);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }

        .modal-content {
            background: var(--soft-cream);
            padding: 2rem;
            border-radius: 20px;
            width: 95%;
            max-width: 800px;
            /* å¢åŠ å¯¬åº¦ä»¥é©æ‡‰ç®¡ç†ä»‹é¢ */
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            border: 1px solid rgba(232, 153, 141, 0.3);
            box-shadow: 0 20px 60px rgba(107, 79, 79, 0.15);
            z-index: 1001;
        }

        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            cursor: pointer;
            font-size: 1.5rem;
            color: #636e72;
            opacity: 0.5;
            transition: opacity 0.2s;
        }

        .modal-close:hover {
            opacity: 1;
        }

        form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        label {
            font-weight: bold;
            margin-bottom: 0.2rem;
            color: #4e342e;
        }

        input:not([type="checkbox"]):not([type="radio"]),
        select,
        textarea {
            width: 100%;
            padding: 0.8rem;
            border-radius: 8px;
            border: 1px solid #ddd;
            font-family: inherit;
            font-size: 1rem;
            color: #4e342e;
            box-sizing: border-box;
            /* ç¢ºä¿ padding ä¸æœƒæ’ç ´å¯¬åº¦ */
        }

        button.btn-submit {
            background: linear-gradient(135deg, var(--primary-coral) 0%, #d4a373 100%);
            color: white;
            border: none;
            padding: 1rem;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            box-shadow: 0 4px 12px rgba(232, 153, 141, 0.3);
            transition: all 0.3s ease;
        }

        button.btn-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(232, 153, 141, 0.4);
        }


        /* ç®¡ç†è€…ä»‹é¢ä½ˆç½®å„ªåŒ– */
        .admin-nav-container {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            margin-bottom: 2rem;
            background: rgba(255, 255, 255, 0.4);
            padding: 1.2rem;
            border-radius: 16px;
            border: 1px solid rgba(232, 153, 141, 0.2);
        }

        .admin-nav-group {
            display: flex;
            flex-direction: column;
            gap: 0.6rem;
        }

        .admin-nav-title {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #b07d62;
            font-weight: 700;
            margin-left: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .admin-tabs {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            border-bottom: none;
            padding-bottom: 0;
        }

        .tab-btn {
            padding: 6px 12px;
            cursor: pointer;
            border-radius: 10px;
            border: 1px solid rgba(232, 153, 141, 0.2);
            font-weight: 600;
            color: #8d7b70;
            background: white;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 0.4rem;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .tab-btn i {
            font-size: 0.9rem;
            opacity: 0.7;
        }

        .tab-btn:hover {
            background: #fffcfb;
            border-color: var(--primary-coral);
            color: var(--primary-coral);
        }

        .tab-btn.active {
            background: var(--primary-coral);
            color: white;
            border-color: var(--primary-coral);
            box-shadow: 0 4px 12px rgba(231, 103, 103, 0.25);
        }

        .tab-btn.active i {
            opacity: 1;
        }


        .admin-list {
            list-style: none;
            padding: 0;
            margin: 0;
            max-height: 50vh;
            overflow-y: auto;
        }

        .batch-actions {
            margin-bottom: 1.5rem;
            display: flex;
            gap: 0.8rem;
            align-items: center;
            flex-wrap: wrap;
            background: #fff;
            padding: 0.8rem 1.2rem;
            border-radius: 12px;
            font-size: 0.9rem;
            border: 1px solid rgba(232, 153, 141, 0.2);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.03);
        }

        .batch-actions label {
            margin: 0;
            font-size: 0.9rem;
            color: #8d7b70;
            cursor: pointer;
        }

        .admin-item {
            background: white;
            margin-bottom: 1rem;
            padding: 1.2rem;
            border-radius: 15px;
            border: 1px solid #f0f0f0;
            display: flex;
            align-items: flex-start;
            gap: 1.2rem;
            font-size: 0.9rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .admin-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(232, 153, 141, 0.12);
            border-color: rgba(232, 153, 141, 0.5);
        }

        .item-checkbox {
            margin-top: 5px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .item-info {
            flex: 1;
        }

        .item-meta {
            font-size: 0.75rem;
            color: #999;
            margin-bottom: 0.5rem;
        }

        .item-target {
            color: var(--primary-coral);
            font-weight: 700;
        }

        .item-content {
            font-size: 1.05rem;
            line-height: 1.6;
            color: #444;
            margin-bottom: 0.5rem;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .admin-actions {
            display: flex;
            gap: 0.5rem;
        }

        .admin-actions button {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            transition: all 0.2s;
        }

        .btn-approve {
            background: #27ae60;
            color: white;
        }

        .btn-reject {
            background: #e74c3c;
            color: white;
        }

        .admin-actions button:hover {
            opacity: 0.8;
            transform: scale(1.05);
        }

        .item-meta span {
            display: inline-block;
        }

        /* å¯«ç•™è¨€æ¨™ç±¤è—¥ä¸¸æ¨£å¼ */
        .tag-pills-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.6rem;
            margin-top: 0.3rem;
        }

        .tag-pill {
            padding: 6px 14px;
            background: white;
            border: 1.5px solid rgba(232, 153, 141, 0.3);
            border-radius: 20px;
            font-size: 0.85rem;
            color: #8d7b70;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
        }

        .tag-pill:hover {
            border-color: var(--primary-coral);
            color: var(--primary-coral);
            background: rgba(232, 153, 141, 0.05);
        }

        .tag-pill.active {
            background: var(--primary-coral);
            color: white;
            border-color: var(--primary-coral);
            box-shadow: 0 4px 10px rgba(230, 103, 103, 0.2);
            transform: translateY(-1px);
        }

        .admin-item .item-checkbox {
            flex-shrink: 0;
            width: 18px;
            height: 18px;
            margin-top: 4px;
        }

        .admin-item .item-info {
            flex: 1;
            min-width: 0;
        }

        .admin-item .item-meta {
            font-size: 0.75rem;
            color: #999;
            margin-bottom: 2px;
        }

        .admin-item .item-content {
            word-break: break-all;
            white-space: normal;
            /* å…è¨±æ›è¡Œ */
            color: #4a3e3e;
            margin: 5px 0;
            line-height: 1.4;
        }

        .admin-item .item-target {
            font-weight: 600;
            color: var(--primary-coral);
        }

        .admin-actions {
            display: flex;
            gap: 0.3rem;
            flex-shrink: 0;
        }

        .btn-approve {
            background: #27ae60;
            color: white;
            border: none;
            padding: 4px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .btn-reject {
            background: #c0392b;
            color: white;

            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
        }

        @media (max-width: 600px) {
            h1 {
                font-size: 1.8rem;
            }

            #messageBoard {
                padding: 1rem;
            }

            .message-card {
                width: 100%;
                position: relative !important;
                opacity: 1 !important;
                transform: none !important;
                animation: none !important;
            }

            .fab-container {
                bottom: 1.5rem;
                right: 1.5rem;
            }

            .fab {
                padding: 0.8rem 1.5rem;
                font-size: 1rem;
            }

            header {
                padding: 1rem;
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .header-content {
                width: 100%;
                justify-content: center;
            }

            .header-actions {
                width: 100%;
                justify-content: center;
            }
        }

        /* å…¬å‘Šç®¡ç†ç·¨è¼¯å€ */
        .ann-editor-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 1rem;
        }

        .ann-editor-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            margin-bottom: 12px;
            background: #fff;
            padding: 12px;
            border-radius: 12px;
            border: 1px solid #eee;
            transition: all 0.3s ease;
        }

        .ann-editor-item:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            border-color: var(--primary-coral);
        }

        .ann-editor-controls {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .btn-sort {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 6px;
            color: #666;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-sort:hover {
            background: #e9ecef;
            color: var(--primary-coral);
        }

        .ann-input {
            flex: 1;
            padding: 10px 14px;
            border: 1px solid #ddd;
            border-radius: 10px;
            font-size: 0.95rem;
            min-height: 80px;
            resize: vertical;
            line-height: 1.5;
            transition: border-color 0.3s;
        }

        .ann-editor-item textarea {
            flex: 1;
            min-height: 40px;
            resize: vertical;
            padding: 8px;
        }

        .btn-add-ann {
            background: #f8f9fa;
            border: 2px dashed #ddd;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            color: #666;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn-add-ann:hover {
            border-color: var(--primary-coral);
            color: var(--primary-coral);
            background: #fff5f2;
        }

        body.post-only-mode #messageBoard,
        body.post-only-mode .fab-container,
        body.post-only-mode .admin-trigger {
            display: none !important;
        }

        body.post-only-mode #postModal .modal-close {
            display: none !important;
        }

        /* æ¸¬è©¦æ¨¡å¼æç¤ºæ¢ */
        .test-notice-banner {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(230, 103, 103, 0.9);
            color: white;
            padding: 12px 25px;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 500;
            z-index: 3000;
            box-shadow: 0 10px 30px rgba(230, 103, 103, 0.3);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideUp 0.5s ease-out;
            pointer-events: none;
        }

        @keyframes slideUp {
            from {
                transform: translate(-50%, 50px);
                opacity: 0;
            }

            to {
                transform: translate(-50%, 0);
                opacity: 1;
            }
        }
    </style>
</head>

<body>
    <div class="ticker-wrapper" id="announcementTicker" style="display: none;">
        <div class="ticker-content" id="tickerContent">
            <!-- å‹•æ…‹æ’å…¥å…¬å‘Šé …ç›® -->
        </div>
    </div>
    <div class="ambient-glow"></div>

    <!-- æ¸¬è©¦æ¨¡å¼æç¤º -->
    <div id="testModeNotice" class="test-notice-banner" style="display: none;">
        <i class="fas fa-info-circle"></i> å…§éƒ¨æ¸¬è©¦ä¸­ï¼Œè«‹ç­‰å¾…æ­£å¼å…¬å‘Šé–‹æ”¾
    </div>

    <header>
        <div class="header-bar">
            <div class="logo-icon">ğŸŒ¸</div>
            <div class="logo-text">
                <h1>å»ºæˆå¿ƒèƒ½é‡</h1>
                <p>Jiancheng Heart Message Wall</p>
            </div>
        </div>
    </header>

    <div id="messageBoard"></div>

    <!-- å…¨è¢å¹•ç‰¹æ•ˆç•«å¸ƒ (æ•ˆèƒ½å„ªåŒ–ï¼šCanvas ç‰¹æ•ˆå¼•æ“) -->
    <canvas id="effectCanvas"
        style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 10000; pointer-events: none;"></canvas>

    <!-- æ•´åˆå¼åŠŸèƒ½çƒï¼šQR + å¯«ç•™è¨€ -->
    <div class="fab-container">
        <!-- å¸¸é§ QR Code (æƒç¢¼å³ç”¨) -->
        <div id="shareWriteQrWrapper" class="fab-qr-wrapper" title="æƒç¢¼å³å¯å¯«ç•™è¨€ï¼ˆå…è¨­å®šï¼‰">
            <img id="fabQrImg" class="fab-qr-img" src="" alt="QR">
        </div>

        <button class="fab" onclick="openPostModal()">
            <i class="fas fa-feather-alt pulsate"></i>
            <span>å¯«ç•™è¨€</span>
        </button>
    </div>

    <!-- å³ä¸‹è§’éš±è—å…¥å£ (ä½æ–¼ adminModal ä¹‹å‰) -->
    <div class="admin-trigger" onclick="openAdminModal()"></div>

    <!-- ç•™è¨€ Modal -->
    <div id="postModal" class="modal-overlay" onclick="if(event.target === this) closeModal('postModal')">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('postModal')">&times;</span>
            <h2 style="color: var(--warm-coral); text-align: center; margin-bottom: 1.5rem;">
                æŠ•ç¨¿æº«æš–</h2>
            <form id="postForm" style="display: flex; flex-direction: column; gap: 0.8rem;">
                <!-- æŠ•ç¨¿æé†’ (æœ€ä¸Šæ–¹) -->
                <div
                    style="background: linear-gradient(135deg, #fff9e6 0%, #fff0f5 100%); padding: 0.8rem 1rem; border-radius: 12px; border-left: 4px solid var(--warm-coral); margin-bottom: 0.2rem;">
                    <p style="font-size: 0.85rem; color: var(--warm-brown); margin: 0; line-height: 1.6;">
                        ğŸ’ <strong>æŠ•ç¨¿å‰è«‹æ³¨æ„ï¼š</strong><br>
                        â€¢ è«‹ç”¨æ­£å‘ã€æº«æš–çš„æ–‡å­—å‚³éå¿ƒæ„<br>
                        â€¢ ç•™è¨€å°‡ç¶“è¼”å°å®¤è€å¸«å¯©æ ¸å¾Œå…¬é–‹é¡¯ç¤ºï¼Œå…©é€±å¾Œè‡ªå‹•ä¸‹æ¶<br>
                        â€¢ è«‹ä½¿ç”¨å€‹äººå­¸æ ¡å¸³è™Ÿç™»å…¥ç•™è¨€ï¼Œè«‹æ„›è­·æ ¡åœ’å‹å–„ç’°å¢ƒ
                    </p>
                </div>

                <!-- 1. èº«åˆ†èˆ‡é¡¯ç¤ºè¨­å®šå€å¡Š (ä¸¦æ’å„ªåŒ–) -->
                <div id="identity-section"
                    style="background: #fff; padding: 0.8rem; border-radius: 12px; border: 1px solid #eee; display: flex; align-items: center; gap: 0.8rem; flex-wrap: wrap;">

                    <!-- Google ç™»å…¥ (å·¦å´) -->
                    <div id="google-login-container" style="position: relative; z-index: 1002; flex: 0 0 auto;">
                        <div id="g_id_onload"
                            data-client_id="236765538215-6o3ol1tl1brqhbd2qfavomq38l7j17aq.apps.googleusercontent.com"
                            data-context="signin" data-ux_mode="popup" data-callback="handleCredentialResponse"
                            data-auto_prompt="false" style="z-index: 2000;">
                        </div>
                        <div class="g_id_signin" data-type="standard" data-shape="rectangular" data-theme="outline"
                            data-text="signin_with" data-size="large" style="z-index: 2000;">
                        </div>
                    </div>

                    <!-- è‡ªè¨‚é¡¯ç¤ºåç¨± (å³å´) -->
                    <div id="custom-name-container"
                        style="flex: 1; min-width: 200px; display: flex; align-items: center; gap: 0.5rem; background: rgba(139, 90, 43, 0.04); padding: 0.5rem 0.8rem; border-radius: 8px; border: 1px dashed rgba(139, 90, 43, 0.1);">
                        <div id="isAnonymous-wrapper"
                            style="display: flex; align-items: center; gap: 0.3rem; white-space: nowrap;">
                            <input type="checkbox" id="isAnonymous" style="width: 16px; height: 16px; cursor: pointer;"
                                onchange="toggleAnonymousName()">
                            <label for="isAnonymous"
                                style="margin: 0; font-weight: 600; cursor: pointer; font-size: 0.85rem;">è‡ªè¨‚åç¨±</label>
                        </div>
                        <div id="anonymousNameRow" style="flex: 1; display: flex; flex-direction: column; gap: 0.3rem;">
                            <label id="anonymousNameLabel"
                                style="display: none; font-weight: bold; color: var(--warm-brown);">æ‚¨çš„ç¨±å‘¼</label>
                            <div id="anonymousNameWrapper" style="display: none; flex: 1; min-width: 0;">
                                <input type="text" id="anonymousName" placeholder="æ‚¨çš„ç¨±å‘¼ (é¸å¡«)" maxlength="10">
                            </div>
                        </div>
                    </div>
                </div>



                <!-- 2. ç•™è¨€å…§å®¹å€å¡Š -->
                <div style="display: flex; flex-direction: column; gap: 0.8rem;">
                    <!-- å°èª°èªªè©± -->
                    <div style="display: flex; flex-direction: column; gap: 0.3rem;">
                        <label style="font-weight: bold; color: var(--warm-brown);">å°èª°èªªè©±ï¼Ÿ</label>
                        <input type="text" id="target" placeholder="ä¾‹å¦‚ï¼š701 å…¨é«”åŒå­¸ã€ç‹è€å¸«..." required>
                    </div>

                    <!-- é¡åˆ¥èˆ‡æ¨™ç±¤ (æ©«å‘ä¸¦æ’) -->
                    <div style="display: flex; flex-wrap: wrap; gap: 1rem; align-items: flex-start;">
                        <div style="flex: 0 0 140px; display: flex; flex-direction: column; gap: 0.3rem;">
                            <label style="font-weight: bold; color: var(--warm-brown);">é¡åˆ¥</label>
                            <select id="tag">
                                <option value="é¼“å‹µ">ğŸ’ª é¼“å‹µ</option>
                                <option value="è®šç¾">âœ¨ è®šç¾</option>
                                <option value="é—œå¿ƒ">ğŸ«‚ é—œå¿ƒ</option>
                                <option value="æ„Ÿè¬">ğŸ‚ æ„Ÿè¬</option>
                                <option value="ç¥ç¦">ğŸˆ ç¥ç¦</option>
                            </select>
                        </div>

                        <div id="topic-tag-wrapper"
                            style="display: none; flex: 1; min-width: 200px; flex-direction: column; gap: 0.3rem;">
                            <label style="font-weight: bold; color: var(--warm-brown);">é¸æ“‡æ´»å‹•æ¨™ç±¤</label>
                            <div id="topic-pills-container" class="tag-pills-container">
                                <!-- ç”± JS å‹•æ…‹ç”¢ç”Ÿ -->
                            </div>
                            <input type="hidden" id="topicTag" value="">
                        </div>
                    </div>

                    <!-- ç•™è¨€å…§å®¹ -->
                    <div style="display: flex; flex-direction: column; gap: 0.3rem;">
                        <label style="font-weight: bold; color: var(--warm-brown);">ç•™è¨€å…§å®¹</label>
                        <div style="position: relative;">
                            <textarea id="content" rows="4" placeholder="å¯«ä¸‹ä½ çš„å¿ƒæ„ (60å­—ä»¥å…§)..." required maxlength="60"
                                oninput="updateCharCount()"></textarea>
                            <div id="charCount"
                                style="position: absolute; bottom: 10px; right: 10px; font-size: 0.75rem; color: #999; pointer-events: none;">
                                0 / 60</div>
                        </div>
                    </div>
                </div>
                <button type="button" class="btn-submit" id="submitBtn" onclick="submitDraft()"
                    style="margin-top: 0.5rem; height: 48px; font-size: 1.1rem; width: 100%;">
                    é€å‡ºç•™è¨€
                </button>
            </form>
        </div>
    </div>

    <!-- ç®¡ç†è€…ä»‹é¢ Modal (åˆä½µè¨­å®š) -->
    <div id="adminModal" class="modal-overlay" onclick="if(event.target === this) closeModal('adminModal')">
        <div class="modal-content" style="max-width: 800px; width: 95%;">
            <span class="modal-close" onclick="closeModal('adminModal')">&times;</span>
            <div style="display: flex; justify-content: center; align-items: center; gap: 10px; margin-bottom: 1rem;">
                <h2 style="color: var(--warm-brown); margin: 0;">ç®¡ç†å¾Œå°</h2>
                <a id="admin-sheet-link"
                    href="https://docs.google.com/spreadsheets/d/1NvB-zNotehm14SQRVR3XgppiLtMA2ZBL-7bqDG2bYmI/edit?gid=0#gid=0"
                    target="_blank" title="é–‹å•Ÿé›²ç«¯è©¦ç®—è¡¨åŸå§‹è³‡æ–™"
                    style="color: #27ae60; font-size: 1.2rem; text-decoration: none; display: none;">
                    <i class="fas fa-file-excel"></i>
                </a>
            </div>



            <div id="admin-management-ui" style="margin-top: 2rem;">


                <div id="admin-login-ui">
                    <p style="font-size: 0.85rem; color: #8d7b70; margin-bottom: 10px;">è«‹è¼¸å…¥å¯†ç¢¼è§£é–ç®¡ç†å“¡æ¬Šé™</p>
                    <div style="display: flex; gap: 10px;">
                        <input type="password" id="adminPassword" placeholder="ç®¡ç†å¯†ç¢¼" style="flex: 1;">
                        <button class="btn-submit" style="padding: 0 20px;" onclick="doAdminLogin()">è§£é–</button>
                    </div>
                </div>

                <div id="admin-panel" style="display:none; margin-top: 1rem;">
                    <div class="admin-nav-container"
                        style="padding: 0.6rem; margin-bottom: 1.2rem; background: transparent; border: none;">
                        <div class="admin-tabs"
                            style="justify-content: flex-start; gap: 0.4rem; overflow-x: auto; padding-bottom: 5px;">
                            <div class="tab-btn active" onclick="switchTab('å¾…å¯©æ ¸')"><i class="fas fa-clock"></i> å¾…å¯©æ ¸
                            </div>
                            <div class="tab-btn" onclick="switchTab('é€šé')"><i class="fas fa-check-circle"></i> é€šé</div>
                            <div class="tab-btn" onclick="switchTab('é§å›')"><i class="fas fa-times-circle"></i> é§å›</div>
                            <div class="tab-btn" onclick="switchTab('å·²ä¸‹æ¶')"><i class="fas fa-archive"></i> ä¸‹æ¶</div>
                            <div
                                style="width: 1px; height: 20px; background: rgba(0,0,0,0.1); margin: 0 4px; align-self: center;">
                            </div>
                            <div class="tab-btn" onclick="switchTab('è·‘é¦¬ç‡ˆç®¡ç†')"><i class="fas fa-bullhorn"></i> è·‘é¦¬ç‡ˆ</div>
                            <div class="tab-btn" onclick="switchTab('æ¨™ç±¤ç®¡ç†')"><i class="fas fa-tags"></i> æ¨™ç±¤</div>
                            <div class="tab-btn" onclick="switchTab('ç‰¹æ•ˆè¨­å®š')"><i class="fas fa-magic"></i> ç‰¹æ•ˆ</div>
                            <div class="tab-btn" onclick="switchTab('ç³»çµ±è¨­å®š')"><i class="fas fa-tools"></i> è¨­å®š</div>
                        </div>
                    </div>

                    <!-- ç•™è¨€ç®¡ç†åˆ†é  -->
                    <div id="tab-content-list" class="tab-pane">
                        <div class="batch-actions" id="batch-actions-bar">
                            <input type="checkbox" id="selectAll" onchange="toggleSelectAll(this)"
                                style="width:20px; height:20px;">
                            <label for="selectAll">å…¨é¸</label>
                            <button class="btn-approve" onclick="batchUpdate('é€šé')">æ‰¹æ¬¡é€šé</button>
                            <button class="btn-reject" onclick="batchUpdate('é§å›')">æ‰¹æ¬¡é§å›</button>
                        </div>
                        <ul id="admin-msg-list" class="admin-list"></ul>
                    </div>

                    <!-- è·‘é¦¬ç‡ˆç®¡ç†åˆ†é  (NEW) -->
                    <div id="admin-ann-panel" class="tab-pane" style="display: none;">
                        <p style="font-size: 0.85rem; color: #888;">è¨­å®šé¡¯ç¤ºåœ¨é ‚éƒ¨çš„è·‘é¦¬ç‡ˆå…§å®¹ï¼ˆæ”¯æ´å¤šå‰‡ï¼‰ï¼š</p>
                        <div id="ann-list-editor" class="ann-editor-container">
                            <!-- ç”± JS å‹•æ…‹ç”¢ç”Ÿç·¨è¼¯æ¡† -->
                        </div>
                        <div class="btn-add-ann" onclick="addAnnEditorRow()" style="margin-top: 1rem;">
                            <i class="fas fa-plus"></i> æ–°å¢ä¸€å‰‡å…¬å‘Š
                        </div>
                        <button class="btn-submit" onclick="saveAnnouncements()"
                            style="margin-top: 1.5rem; width: 100%;">
                            å„²å­˜ä¸¦æ›´æ–°è·‘é¦¬ç‡ˆ
                        </button>
                        </button>
                    </div>

                    <!-- ç‰¹æ•ˆè¨­å®šåˆ†é  (NEW) -->
                    <div id="admin-effect-panel" class="tab-pane" style="display: none;">
                        <p style="font-size: 0.85rem; color: #888;">è¨­å®šé—œéµå­—è§¸ç™¼çš„ç‰¹æ•ˆï¼ˆæ”¯æ´ Emoji èˆ‡å¤šç¨®å‹•æ…‹ï¼‰ï¼š</p>

                        <!-- æ–°å¢è¦å‰‡è¡¨å–® -->
                        <div
                            style="background: #fff5f2; padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 1px dashed #e66767;">
                            <h4 style="margin: 0 0 10px 0; color: #e66767; font-size: 0.95rem;">æ–°å¢ç‰¹æ•ˆè¦å‰‡</h4>
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <input type="text" id="new-effect-keyword" placeholder="é—œéµå­— (e.g. æ–°å¹´)" class="ann-input"
                                    style="min-height: 40px; flex: 2;">
                                <input type="text" id="new-effect-icon" placeholder="Emoji (e.g. ğŸ§§)" class="ann-input"
                                    style="min-height: 40px; flex: 1; text-align: center;">
                                <select id="new-effect-mode" class="ann-input" style="min-height: 40px; flex: 2;">
                                    <option value="burst">ğŸ’¥ å™´ç™¼ (Burst)</option>
                                    <option value="float">ğŸˆ æ¼‚æµ® (Float)</option>
                                    <option value="rain">ğŸŒ§ï¸ é›¨è½ (Rain)</option>
                                    <option value="spiral">ğŸŒ€ èºæ—‹ (Spiral)</option>
                                    <option value="firework">ğŸ† ç…™ç« (Firework)</option>
                                    <option value="sparkle">âœ¨ é–ƒçˆ (Sparkle)</option>
                                    <option value="snow">â„ï¸ é£„é›ª (Snow)</option>
                                    <option value="bounce">ğŸ€ å½ˆè·³ (Bounce)</option>
                                    <option value="pulse">ğŸ’“ è„ˆå‹• (Pulse)</option>
                                </select>
                                <button class="btn-approve" onclick="previewCurrentEffect()"
                                    style="flex: 1; white-space: nowrap; background: #6c5ce7; border-color: #6c5ce7;">é è¦½</button>
                                <button class="btn-approve" id="btn-add-effect" onclick="addEffectRule()"
                                    style="flex: 1; white-space: nowrap;">æ–°å¢</button>
                            </div>
                            <input type="hidden" id="edit-effect-index" value="-1">
                        </div>

                        <!-- è¦å‰‡åˆ—è¡¨ -->
                        <div id="effect-list-editor" class="ann-editor-container">
                            <!-- JS å‹•æ…‹ç”¢ç”Ÿ -->
                        </div>

                        <button class="btn-submit" onclick="saveKeywordEffects()"
                            style="margin-top: 1.5rem; width: 100%;">
                            å„²å­˜ç‰¹æ•ˆè¨­å®š
                        </button>
                    </div>

                    <!-- æ¨™ç±¤ç®¡ç†åˆ†é  (REFINED) -->
                    <div id="admin-topic-panel" class="tab-pane" style="display: none;">
                        <h4 style="margin: 0 0 10px 0; color: #b07d62; font-size: 0.95rem;">æ¨™ç±¤ç®¡ç†</h4>
                        <p style="font-size: 0.85rem; color: #888;">
                            åœ¨é€™è£¡ç®¡ç†ç•™è¨€æ›è¼‰çš„æ¨™ç±¤ã€‚æ‚¨å¯ä»¥è¨­å®šæ¨™ç±¤åº«ï¼Œä¸¦å‹¾é¸ç›®å‰è¦åœ¨æŠ•ç¨¿æˆ–é›»è¦–ç‰†é¡¯ç¤ºçš„é …ç›®ã€‚
                        </p>

                        <!-- æ–°å¢æ¨™ç±¤ -->
                        <div
                            style="background: #fff5f2; padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 1px dashed #b07d62;">
                            <div style="display: flex; gap: 10px;">
                                <input type="text" id="new-topic-tag-input" placeholder="æ–°æ¨™ç±¤ (ä¾‹å¦‚ï¼š#å­¸æ ¡æ—¥)"
                                    class="ann-input" style="min-height: 40px; flex: 1;">
                                <button class="btn-approve" onclick="addTopicToLibrary()"
                                    style="padding: 0 20px;">æ–°å¢æ¨™ç±¤</button>
                            </div>
                        </div>

                        <!-- æ¨™ç±¤åˆ—è¡¨ -->
                        <div id="topic-list-container" class="ann-editor-container"
                            style="max-height: 400px; overflow-y: auto;">
                            <!-- JS å‹•æ…‹ç”¢ç”Ÿæ¨™ç±¤åˆ— -->
                        </div>

                        <button class="btn-submit" onclick="saveTopicConfig()" style="margin-top: 1.5rem; width: 100%;">
                            å„²å­˜æ¨™ç±¤è¨­å®š
                        </button>
                    </div>

                    <!-- ç³»çµ±è¨­å®š -->
                    <div id="admin-settings-panel" class="tab-pane" style="display: none;">
                        <h4 style="margin: 0 0 10px 0; color: #b07d62; font-size: 0.95rem;">ç³»çµ±è¨­å®š</h4>
                        <div class="admin-nav-container">
                            <div class="admin-nav-group">
                                <label class="admin-nav-title"><i class="fas fa-user-shield"></i> æŠ•ç¨¿æ¬Šé™æ§ç®¡</label>
                                <select id="submissionModeSelect" class="tab-btn"
                                    style="width: 100%; height: 42px; background: white; border: 1px solid #ddd; padding: 0 10px;">
                                    <option value="school">ğŸ« å­¸æ ¡å¸³è™Ÿ (éœ€è¦ç™»å…¥)</option>
                                    <option value="public">ğŸŒ å®Œå…¨é–‹æ”¾ (è¨ªå®¢å…ç™»å…¥)</option>
                                    <option value="closed">ğŸ”’ æš«åœæŠ•ç¨¿ (åƒ…ä¾›ç€è¦½)</option>
                                </select>
                                <p style="font-size: 0.8rem; color: #999; margin: 5px 0 0 5px;">* æ´»å‹•æœŸé–“å¯é–‹å•Ÿå®Œå…¨é–‹æ”¾ï¼Œè®“å¤–è³“ä¹Ÿèƒ½å‚³éæº«æš–ã€‚
                                </p>
                            </div>

                            <div class="admin-nav-group" style="margin-top: 15px;">
                                <label class="admin-nav-title"><i class="fas fa-desktop"></i> é›»è¦–ç‰†æ¨¡å¼</label>
                                <label
                                    style="display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 12px; background: white; border-radius: 12px; border: 1px solid #eee;">
                                    <input type="checkbox" id="toggleInternalTest" style="width: 18px; height: 18px;">
                                    <span style="font-weight: 600; color: #555;">å•Ÿç”¨å…§éƒ¨æ¸¬è©¦æ¨¡å¼ (éš±è—äº’å‹•æŒ‰éˆ•)</span>
                                </label>
                            </div>
                        </div>

                        <button class="btn-submit" onclick="saveSystemConfig()"
                            style="margin-top: 1.5rem; width: 100%;">
                            å„²å­˜ç³»çµ±è¨­å®š
                        </button>
                    </div>
                </div>
            </div>

            <div style="text-align: right; margin-top: 1rem;">
                <button onclick="logoutAdmin()"
                    style="font-size: 0.8rem; border:none; background:none; text-decoration: underline; color: #999; cursor:pointer;">ç™»å‡ºç®¡ç†å“¡èº«åˆ†</button>
            </div>
        </div>
    </div>
    </div>


    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script>
        // --- è¨­å®šèˆ‡è®Šæ•¸ ---
        const _G = "https://script.google.com/macros/s/AKfycbzZOrUP3veKI5oexCOwUHqLXeduo4bRlpRoglpCF-zl1NxeLuKDTBcJg7o0Acx9qC0R/exec";
        let currentUserEmail = null;
        let currentUserName = null;
        let allMessages = [];
        let pendingSequence = []; // å¾…é¡¯ç¤ºéš¨æ©Ÿåºåˆ—
        let isInternalTest = false; // å…§éƒ¨æ¸¬è©¦æ¨¡å¼ç‹€æ…‹
        let currentEffects = []; // å„²å­˜ç‰¹æ•ˆè¦å‰‡
        let topicConfig = { library: "", activeSubmissionTags: "", defaultWallTags: "" }; // æ´»å‹•æ¨™ç±¤è¨­å®š
        let currentFilterTag = ""; // ç•¶å‰éæ¿¾æ¨™ç±¤
        let currentSubmissionMode = "school"; // ç•¶å‰æŠ•ç¨¿æ¨¡å¼ (school, public, closed)
        // æ•æ„Ÿè©æ¸…å–®ï¼ˆå¯è‡ªè¡Œæ“´å……ï¼‰
        const SENSITIVE_WORDS = [
            'ç¬¨è›‹', 'ç™½ç™¡', 'å»æ­»', 'æ™ºéšœ', 'å»¢ç‰©', 'åƒåœ¾', 'æ»¾', 'çˆ›',
            'å¹¹', 'é ', 'åª½çš„', 'ä»–åª½', 'å±', 'è³¤', 'å©Š', 'æ¸£',
            'fuck', 'shit', 'damn', 'bitch', 'stupid', 'idiot'
        ];

        // --- æ•æ„Ÿè©æª¢æ¸¬ ---
        function containsSensitiveWords(text) {
            const lowerText = text.toLowerCase();
            return SENSITIVE_WORDS.some(word => lowerText.includes(word.toLowerCase()));
        }

        // --- å„ªå…ˆé †åºé‚è¼¯ ---
        function getGasUrl() {
            return _G;
        }



        // --- åˆå§‹åŒ–é é¢ ---
        // å…¨åŸŸè¼ªæ’­è¨ˆæ™‚å™¨ï¼Œç¢ºä¿æ‰‹å‹•èˆ‡è‡ªå‹•è¼ªæ’­åŒæ­¥ï¼Œé¿å…åŒæ™‚å‡ºå¡
        let lastRotateTimestamp = 0;

        window.onload = () => {
            const urlParams = new URLSearchParams(window.location.search);
            const isDisplayMode = urlParams.has('view') && urlParams.get('view') === 'wall';
            const isAdminMode = urlParams.has('admin');

            // é è¨­çš†ç‚ºæŠ•ç¨¿æ¨¡å¼ï¼Œé™¤éæ˜ç¢ºé–‹å•Ÿé¡¯ç¤ºç‰†æˆ–ç®¡ç†æ¨¡å¼
            if (!isDisplayMode && !isAdminMode) {
                document.body.classList.add('post-only-mode');
            }

            const url = getGasUrl();
            // è¼‰å…¥æ¨™ç±¤è¨­å®š
            if (url) loadTopicConfig();
            if (url) checkSystemConfig();

            // åªæœ‰åœ¨é¡¯ç¤ºæ¨¡å¼æˆ–ç®¡ç†æ¨¡å¼ä¸‹ï¼Œæ‰è¼‰å…¥ç•™è¨€èˆ‡å…¬å‘Š
            if (url && (isDisplayMode || isAdminMode)) {
                loadAnnouncements();
                loadKeywordEffects();

                // æª¢æŸ¥ URL åƒæ•¸ä¸­çš„æ¨™ç±¤éæ¿¾ (å›å¾©æ¨™æº–è§£æ)
                currentFilterTag = urlParams.get('tag') || "";

                // loadMessages ç§»é™¤ setTimeoutï¼Œæ”¹ç”±ç›¸ä¾è³‡æ–™è¼‰å…¥å¾Œè§¸ç™¼
                loadMessages(); // ç«‹å³è¼‰å…¥ï¼Œä¸ç­‰å¾… setInterval
                setInterval(loadMessages, 20000);
                setInterval(loadAnnouncements, 45000);
                setInterval(checkSystemConfig, 60000);

                // ä½¿ç”¨ rAF é©…å‹•çš„å¡ç‰‡è¼ªæ’­ (é¿å… setInterval çš„é˜»å¡æ„Ÿ)
                const rotateLoop = (time) => {
                    // å…¨åŸŸæ§åˆ¶ï¼šlastRotateTimestamp æœƒè¢« rotateMessages åŒæ­¥æ›´æ–°
                    if (time - lastRotateTimestamp >= 4000) {
                        rotateMessages();
                        // é€™è£¡ä¸éœ€è¦æ‰‹å‹• setï¼Œå› ç‚º rotateMessages å…§éƒ¨æœƒæ›´æ–°ï¼Œç¢ºä¿æ‰€æœ‰å‘¼å«ä¾†æºéƒ½èƒ½é‡ç½®è¨ˆæ™‚
                    }
                    requestAnimationFrame(rotateLoop);
                };
                requestAnimationFrame(rotateLoop);

                // é›»è¦–ç‰†ç©©å®šæ€§ï¼šæ¯ 30 åˆ†é˜è‡ªå‹•é‡æ–°æ•´ç†ä¸€æ¬¡ç¶²é ï¼Œç¢ºä¿ code æ›´æ–°èƒ½åŠæ™‚ç”Ÿæ•ˆä¸¦é‡‹æ”¾è¨˜æ†¶é«”
                if (isDisplayMode) {
                    setInterval(() => location.reload(), 1800000);
                }
            }

            // é ç”Ÿæˆåˆ†äº«ç”¨çš„å¯«ç•™è¨€ QR Code
            generateWriteQrCode();

            // é—œéµåŠŸèƒ½ï¼šæŠ•ç¨¿åµæ¸¬ï¼ˆé è¨­æ¨¡å¼ä¹Ÿæœƒè‡ªå‹•é–‹å•Ÿï¼‰
            if (urlParams.has('write') || (!isDisplayMode && !isAdminMode)) {
                setTimeout(openPostModal, 1500);
            }

            // ç›´æ¥é€²å…¥ç®¡ç†å¾Œå°æª¢æ¸¬
            if (urlParams.has('admin')) {
                setTimeout(openAdminModal, 500);
            }
        };

        // --- ç”Ÿæˆå¯«ç•™è¨€å°ˆç”¨ QR Code (å„ªåŒ–ï¼šä½¿ç”¨éœæ…‹ Vercel ç¶²å€) ---
        function generateWriteQrCode() {
            const qrImg = document.getElementById('fabQrImg');
            if (!qrImg) return;
            const fullShareUrl = "https://jcjh.vercel.app/jcjh-heart.html?write=true";
            qrImg.src = `https://quickchart.io/qr?text=${encodeURIComponent(fullShareUrl)}&size=200&margin=1&dark=c23a3a&light=ffffff`;
            console.log("å·²ç”Ÿæˆå¯«ç•™è¨€å°ˆç”¨éœæ…‹ QR Code");
        }


        // --- åˆ‡æ›é¡¯ç¤º/éš±è—åˆ†äº« QR Code ---
        function toggleShareWriteQr() {
            const wrapper = document.getElementById('shareWriteQrWrapper');
            const btn = document.getElementById('shareWriteBtn');
            const gasUrl = getGasUrl();

            // æª¢æŸ¥æ˜¯å¦å·²è¨­å®š GAS URL
            if (!gasUrl || gasUrl === '') {
                showModal('å°šæœªè¨­å®š', 'è«‹å…ˆåœ¨ç®¡ç†å¾Œå°è¨­å®š GAS é€£ç·šç¶²å€å¾Œï¼Œæ‰èƒ½ç”Ÿæˆåˆ†äº«ç”¨çš„ QR Code', 'warning');
                return;
            }

            const isVisible = wrapper.style.display !== 'none';

            if (isVisible) {
                wrapper.style.display = 'none';
                btn.classList.remove('active');
            } else {
                generateWriteQrCode(); // ç¢ºä¿ QR Code æ˜¯æœ€æ–°çš„
                wrapper.style.display = 'block';
                btn.classList.add('active');

                // æç¤ºä½¿ç”¨è€…
                showModal('åˆ†äº« QR Code', 'è®“å…¶ä»–äººæƒç¢¼å³å¯ç›´æ¥ç•™è¨€ï¼Œç„¡éœ€è¨­å®šï¼', 'success');
            }
        }


        // --- åˆ‡æ›åŒ¿åæš±ç¨±è¼¸å…¥ ---
        function toggleAnonymousName() {
            const wrapper = document.getElementById('anonymousNameWrapper');
            const checkbox = document.getElementById('isAnonymous');
            wrapper.style.display = checkbox.checked ? 'block' : 'none';
        }

        // --- æ ¸å¿ƒåŠŸèƒ½ï¼šæª¢æŸ¥ç³»çµ±è¨­å®š (æ¸¬è©¦æ¨¡å¼) ---
        async function checkSystemConfig() {
            const config = await fetchAPI('getSystemConfig');
            if (config) {
                if (typeof config.isInternalTest !== 'undefined') isInternalTest = config.isInternalTest;
                if (typeof config.submissionMode !== 'undefined') currentSubmissionMode = config.submissionMode;
                applySystemConfig();
            }
        }

        function applySystemConfig() {
            const urlParams = new URLSearchParams(window.location.search);
            const isDisplayMode = urlParams.has('view') && urlParams.get('view') === 'wall';
            const fab = document.querySelector('.fab-container');
            const notice = document.getElementById('testModeNotice');

            if (isInternalTest) {
                // å¦‚æœæ˜¯æ¸¬è©¦æ¨¡å¼ä¸”åœ¨é›»è¦–ç‰†ï¼Œå‰‡éš±è—æŒ‰éˆ•ä¸¦é¡¯ç¤ºæç¤º
                if (isDisplayMode) {
                    if (fab) fab.style.display = 'none';
                    if (notice) notice.style.display = 'flex';
                }
            } else {
                if (isDisplayMode) {
                    if (fab) fab.style.display = 'flex';
                    if (notice) notice.style.display = 'none';
                }
            }
        }
        // --- API ä¸²æ¥ ---
        async function fetchAPI(action, data = null, params = null) {
            const url = getGasUrl();
            if (!url) {
                showModal('éŒ¯èª¤', 'æœªè¨­å®š GAS ç¶²å€', 'error');
                return null;
            }

            try {
                // ä¿®æ­£é‚è¼¯ï¼šåˆ¤æ–·å“ªäº›è¡Œå‹•æ‡‰è©²ä½¿ç”¨ POST
                const isPost = (action === 'submitMessage' || action === 'updateStatus' || action === 'updatePin' || action === 'adminGetMessages' || action === 'updateAnnouncements' || action === 'updateSystemConfig' || action === 'updateKeywordEffects' || action === 'updateTopicConfig' || action === 'updateMessage' || action === 'renameTopicTag');

                const options = {
                    method: isPost ? 'POST' : 'GET',
                    mode: 'cors'
                };

                let targetUrl = url;
                if (!isPost) {
                    // å…¨é¢ä¿®å¾©ï¼šæ‰€æœ‰ GET è«‹æ±‚éƒ½å¿…é ˆåŒ…å« action èˆ‡åƒæ•¸
                    targetUrl += `?action=${action}`;
                    if (params) {
                        for (let k in params) targetUrl += `&${k}=${encodeURIComponent(params[k])}`;
                    }
                } else {
                    // POST è«‹æ±‚ï¼šå°‡è³‡æ–™èˆ‡è¡Œå‹•åŒ…è£åœ¨ Body
                    options.body = JSON.stringify({ ...data, action, ...params }); // Merge params into body for POST
                }

                const response = await fetch(targetUrl, options);
                const result = await response.json();

                if (result.error) {
                    showModal('API è¨Šæ¯', result.error, 'warning');
                    return null;
                }
                return result;
            } catch (err) {
                console.error(err);
                showModal('é€£ç·šå¤±æ•—', 'ç„¡æ³•èˆ‡æœå‹™ç«¯é€šè¨Šï¼Œè«‹æª¢æŸ¥ç¶²å€æ˜¯å¦æ­£ç¢ºã€‚', 'error');
                return null;
            }
        }

        // --- æ ¸å¿ƒåŠŸèƒ½ï¼šè®€å–å…¬å‘Šè·‘é¦¬ç‡ˆ ---
        let currentAnnouncements = [];
        async function loadAnnouncements() {
            const ticker = document.getElementById('announcementTicker');
            const content = document.getElementById('tickerContent');
            const res = await fetchAPI('getAnnouncements');

            if (res && Array.isArray(res) && res.length > 0) {
                currentAnnouncements = res;
                content.innerHTML = '';
                // é‡è¤‡å…©æ¬¡ä»¥å¯¦ç¾ç„¡ç¸«æ»¾å‹•æ•ˆæœ
                const items = res.map(a => `<div class="ticker-item"><i class="fas fa-bullhorn"></i> ${a.content}</div>`).join('');
                content.innerHTML = items + items; // é›™å€å…§å®¹ç¢ºä¿å¾ªç’°
                ticker.style.display = 'flex';
                // æ ¹æ“šå…¬å‘Šé•·åº¦å‹•æ…‹èª¿æ•´å‹•ç•«æ™‚é–“ (å›å¾©è‡³æ¯å‰‡ 45sï¼Œç¶­æŒæœ€èˆ’é©çš„æ…¢ç¯€å¥)
                content.style.animationDuration = `${res.length * 45}s`;
            } else {
                ticker.style.display = 'none';
            }
        }
        async function loadMessages() {
            const board = document.getElementById('messageBoard');
            const result = await fetchAPI('getMessages');
            if (result && !result.error) {
                allMessages = result;

                // æ¨™ç±¤éæ¿¾é‚è¼¯
                let filterToUse = currentFilterTag || (topicConfig.defaultWallTags ? topicConfig.defaultWallTags.split(',').map(t => t.trim()) : []);
                if (typeof filterToUse === 'string') filterToUse = [filterToUse];
                filterToUse = filterToUse.filter(t => t);

                if (filterToUse.length > 0) {
                    allMessages = allMessages.filter(m => {
                        const mTag = m.topicTag ? m.topicTag.trim() : "";
                        return filterToUse.some(f => mTag === f.trim());
                    });
                }

                if (pendingSequence.length === 0 && allMessages.length > 0) {
                    refreshSequence();
                }
                if (allMessages.length === 0) {
                    board.innerHTML = '<div style="opacity:0.5;">ç›®å‰é‚„æ²’æœ‰æº«æš–çš„ç•™è¨€ï¼Œå¿«ä¾†å¯«ç¬¬ä¸€å‰‡å§ï¼</div>';
                } else if (board.innerHTML.includes('ç›®å‰é‚„æ²’æœ‰')) {
                    board.innerHTML = '';
                }

                // è‹¥å‰›è¼‰å…¥ä¸”ç•«é¢å…¨ç©ºï¼Œç«‹å³è§¸ç™¼ç¬¬ä¸€å¼µï¼Œé¿å…ç­‰å¾…
                if (board.querySelectorAll('.message-card').length === 0) {
                    rotateMessages();
                }
                // ä¸å†åŸ·è¡Œ board.innerHTML = ''ï¼Œè®“ rotateMessages è‡ªç„¶æ›´è¿­ç•™è¨€
            }
        }

        // --- æ ¸å¿ƒåŠŸèƒ½ï¼šéš¨æ©Ÿæ—‹è½‰ç•™è¨€å¡ç‰‡ ---
        let displayingIndexes = new Set(); // è¿½è¹¤ç•¶å‰æ­£åœ¨ç•«é¢ä¸Šçš„å¡ç‰‡

        // --- éš¨æ©Ÿåºåˆ—ç®¡ç†å·¥å…· ---
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function refreshSequence() {
            if (allMessages.length === 0) return;
            pendingSequence = shuffleArray([...Array(allMessages.length).keys()]);
            console.log("éš¨æ©Ÿåºåˆ—å·²é‡ç½®", pendingSequence.length);
        }

        function getNextMessageIndex() {
            if (allMessages.length === 0) return undefined;
            if (pendingSequence.length === 0) refreshSequence();

            for (let i = pendingSequence.length - 1; i >= 0; i--) {
                const idx = pendingSequence[i];
                if (idx >= allMessages.length) {
                    pendingSequence.splice(i, 1);
                    continue;
                }
                if (!displayingIndexes.has(idx)) {
                    return pendingSequence.splice(i, 1)[0];
                }
            }
            return undefined;
        }

        function rotateMessages() {
            // å¼·åˆ¶æª¢æŸ¥æ™‚é–“é–“éš”ï¼Œé˜²æ­¢å¤šé‡è§¸ç™¼ä¾†æºå°è‡´å¡ç‰‡é€£ç™¼
            const now = performance.now();
            // å¦‚æœè·é›¢ä¸Šæ¬¡å‡ºå¡ä¸åˆ° 3.5 ç§’ (é ç•™ç·©è¡)ï¼Œå‰‡æœ¬æ¬¡è·³é
            if (now - lastRotateTimestamp < 3500) return;

            lastRotateTimestamp = now;

            if (allMessages.length === 0) return;

            const board = document.getElementById('messageBoard');
            if (!board) return;
            const boardWidth = board.clientWidth;
            const boardHeight = board.clientHeight;

            // æ ¹æ“šè¨­å‚™èƒ½åŠ›èª¿æ•´å…±å­˜å¡ç‰‡æ•¸é‡ (æ¢å¾©é›»è…¦ç‰ˆè±ç››æ„Ÿ)
            const isMobile = window.innerWidth < 600;
            const targetCount = isMobile ? 3 : 6;
            const maxOnScreen = Math.min(targetCount, allMessages.length);

            // æ¯æ¬¡æª¢æŸ¥æ™‚ï¼š
            // åªå˜—è©¦è£œ 1 å¼µå¡ç‰‡ (é…åˆ 4ç§’é€±æœŸ + å¡ç‰‡æ¶ˆå¤±å¾Œçš„ä¸»å‹•è§¸ç™¼)
            // é”æˆéŒ¯è½æ„Ÿï¼šæ™‚é–“åˆ°è£œä¸€å¼µï¼Œæœ‰äººèµ°ä¹Ÿè£œä¸€å¼µ
            let currentCount = board.querySelectorAll('.message-card').length;

            if (currentCount < maxOnScreen) {
                const randomPick = getNextMessageIndex();
                if (randomPick !== undefined) {
                    displayingIndexes.add(randomPick);
                    createCard(allMessages[randomPick], boardWidth, boardHeight, randomPick);
                }
            }
        }

        // é è¨ˆç®—ä½ç½®ï¼ˆæ›´è‡ªç„¶çš„æ•£ä½ˆï¼‰
        // é è¨ˆç®—ä½ç½®ï¼ˆä½¿ç”¨æœ€ä½³é©é…æ¼”ç®—æ³•ï¼‰
        let gridPositions = [];

        // è¦–çª—å¤§å°æ”¹è®Šæ™‚ï¼Œé‡ç½®ç¶²æ ¼ä»¥é‡æ–°è¨ˆç®—æœ€ä½³ä½ç½®
        window.addEventListener('resize', () => {
            gridPositions = [];
        });

        function calculateGridPositions() {
            gridPositions = [];
            const bw = window.innerWidth;
            const bh = window.innerHeight;
            const cardW = 340;
            const cardH = 260;

            const marginT = 100;
            const marginB = 50;  // ç¸®å°åº•éƒ¨é‚Šè·ï¼Œå…è¨±å¡ç‰‡å»¶ä¼¸åˆ°ä¸‹æ–¹ (åŸ 140)
            const marginLR = 50;

            const availableW = bw - marginLR * 2;
            const availableH = bh - marginT - marginB;

            // å¢åŠ ç¶²æ ¼å¯†åº¦ï¼Œæä¾›æ›´å¤šå€™é¸ä½ç½® (4x3 -> 5x4)
            // é€™è£¡çš„é–“è· (20) è¨­å¾—è¼ƒå°ï¼Œæ˜¯ç‚ºäº†ç”¢ç”Ÿæ›´å¤šäº¤éŒ¯çš„å€™é¸é»
            const cols = Math.max(3, Math.floor(availableW / (cardW + 20)));
            const rows = Math.max(3, Math.floor(availableH / (cardH + 20)));

            const cellW = availableW / cols;
            const cellH = availableH / rows;

            for (let r = 0; r < rows; r++) {
                for (let c = 0; c < cols; c++) {
                    const offsetX = (cellW - cardW) / 2 + (Math.random() - 0.5) * (cellW * 0.4);
                    const offsetY = (cellH - cardH) / 2 + (Math.random() - 0.5) * (cellH * 0.4);

                    gridPositions.push({
                        x: marginLR + c * cellW + offsetX,
                        y: marginT + r * cellH + offsetY,
                        rot: (Math.random() - 0.5) * 12
                    });
                }
            }
            // éš¨æ©Ÿæ‰“äº‚å€™é¸æ± 
            gridPositions.sort(() => Math.random() - 0.5);
        }

        // --- è¿½è¹¤é‡˜é¸å…¬å‘Šå‚ç›´å †ç–Šç‹€æ…‹ ---
        function createCard(msg, bw, bh, index) {
            const board = document.getElementById('messageBoard');
            const card = document.createElement('div');
            card.className = `message-card animate-float`;

            // 1. å–å¾—ç•«é¢ä¸Šæ‰€æœ‰ç¾å­˜å¡ç‰‡çš„ä½ç½® (Collision Detection)
            const existingCards = Array.from(board.querySelectorAll('.message-card')).map(el => {
                const rect = el.getBoundingClientRect();
                // å–å¡ç‰‡ä¸­å¿ƒé»ä½œç‚ºè·é›¢è¨ˆç®—åŸºæº–ï¼Œæ¯”å·¦ä¸Šè§’æ›´æº–ç¢º
                return { x: rect.left + rect.width / 2, y: rect.top + rect.height / 2 };
            });

            // 2. ç¢ºä¿å€™é¸ç¶²æ ¼å·²ç”Ÿæˆ
            if (gridPositions.length === 0) calculateGridPositions();

            // 3. å°‹æ‰¾æœ€ä½³ä½ç½®ï¼šæŒ‘é¸ã€Œé›¢æ‰€æœ‰ç¾æœ‰å¡ç‰‡æœ€é ã€çš„å€™é¸é»
            let bestPos = gridPositions[0];
            let maxMinDist = -1;

            // éš¨æ©Ÿé¸å– 10 å€‹å€™é¸é»é€²è¡Œè©•ä¼° (é¿å…è¨ˆç®—é‡éå¤§ï¼Œé›–åªæœ‰å¹¾åå€‹é»å…¶å¯¦å…¨è·‘ä¹Ÿæ²’é—œä¿‚)
            // ç‚ºäº†æ•ˆèƒ½èˆ‡éš¨æ©Ÿæ€§ï¼Œæˆ‘å€‘éæ­·æ‰€æœ‰å€™é¸é»ï¼Œå› ç‚ºæ•¸é‡ä¸å¤š (ç´„ 20-30 å€‹)
            for (const pos of gridPositions) {
                // è¨ˆç®—æ­¤å€™é¸é»(ä¸­å¿ƒ)èˆ‡æ‰€æœ‰ç¾å­˜å¡ç‰‡(ä¸­å¿ƒ)çš„æœ€è¿‘è·é›¢
                // é ä¼°å¡ç‰‡ä¸­å¿ƒ x = pos.x + 170, y = pos.y + 130
                const centerX = pos.x + 170;
                const centerY = pos.y + 130;

                let minDist = Infinity;

                if (existingCards.length === 0) {
                    minDist = Infinity;
                } else {
                    for (const exist of existingCards) {
                        const dx = centerX - exist.x;
                        const dy = centerY - exist.y;
                        const dist = Math.sqrt(dx * dx + dy * dy);
                        if (dist < minDist) minDist = dist;
                    }
                }

                // æ›´æ–°æœ€ä½³è§£
                if (minDist > maxMinDist) {
                    maxMinDist = minDist;
                    bestPos = pos;
                }
            }

            // ä½¿ç”¨è©•ä¼°å‡ºçš„æœ€ä½³ä½ç½® (å¦‚æœ maxMinDist ä»å¾ˆå°ï¼Œè¡¨ç¤ºè¢å¹•çœŸçš„å¾ˆæ»¿ï¼Œä½†ä¹Ÿç›¡åŠ›é¸äº†æœ€ç©ºçš„)

            // å®‰å…¨é™åˆ¶ï¼šç¢ºä¿å¡ç‰‡å®Œå…¨åœ¨å¯è¦‹ç¯„åœå…§ (é ç•™é‚Šè·)
            const safeX = Math.max(30, Math.min(bestPos.x, bw - 380));
            const safeY = Math.max(80, Math.min(bestPos.y, bh - 320));

            card.style.setProperty('--rot', `${bestPos.rot}deg`);
            card.style.top = `${safeY}px`;
            card.style.left = `${safeX}px`;

            // --- éƒµæˆ³æ—¥æœŸè™•ç† (ä½¿ç”¨åŸå§‹æŠ•ç¨¿æ™‚é–“) ---
            const dateObj = new Date(msg.timestamp);
            const stampMonth = (dateObj.getMonth() + 1).toString().padStart(2, '0');
            const stampDay = dateObj.getDate().toString().padStart(2, '0');
            const stampRot = (Math.random() * 20 - 10); // éš¨æ©Ÿè“‹ç« åè½‰
            card.style.setProperty('--stamp-rot', `${stampRot}deg`);



            // éš¨æ©Ÿè† å¸¶ä½ç½®é‚è¼¯
            const tapePos = Math.random() > 0.5 ? '20px' : '230px';
            const tapeRot = (Math.random() * 20 - 10) + (tapePos === '20px' ? -15 : 15);
            card.style.setProperty('--tape-pos', tapePos);
            card.style.setProperty('--tape-rot', tapeRot + 'deg');

            // --- å…§å®¹è™•ç†ï¼šMarkdown èˆ‡ æ›è¡Œåµæ¸¬ ---
            const hasNewline = msg.content.includes('\n');
            const renderedContent = typeof marked !== 'undefined' ? marked.parse(msg.content) : msg.content;

            // --- æ›´ç´°ç·»çš„å­—ç´šå„ªåŒ–ï¼Œå› ç‚ºå¡ç‰‡å·²å›ºå®šé«˜åº¦ 260px ---
            const contentLen = msg.content.length;
            let sizeClass = "size-small";
            if (contentLen < 12) sizeClass = "size-large";
            else if (contentLen < 27) sizeClass = "size-medium";
            // 27~60 å­—ä½¿ç”¨ smallï¼Œè¶…é 60 ä½¿ç”¨ mini
            else if (contentLen >= 60) sizeClass = "size-mini";



            // --- é—œéµå­—ç‰¹æ•ˆåµæ¸¬ (æ”¯æ´å¤šå€‹é—œéµå­—ç”¨é€—è™Ÿåˆ†éš”) ---
            let matchedEffect = null;
            if (currentEffects && currentEffects.length > 0) {
                let firstIndex = Infinity;
                currentEffects.forEach(eff => {
                    const keywords = eff.keyword.split(',').map(k => k.trim());
                    keywords.forEach(kw => {
                        const idx = msg.content.indexOf(kw);
                        if (idx !== -1 && idx < firstIndex) {
                            firstIndex = idx;
                            matchedEffect = eff;
                        }
                    });
                });

                if (matchedEffect) {
                    card.dataset.autoEffect = "true";
                    card.dataset.effectMode = matchedEffect.mode;
                    card.dataset.effectIcon = matchedEffect.icon;
                }
            }

            // --- å…§å®¹è™•ç†ï¼šæ¢å¾©åŸå§‹å‘ˆç¾ (ä¸é€²è¡Œ Markdown è§£ææˆ–éæ¿¾) ---
            let contentHtml = msg.content;

            card.innerHTML = `
                <div class="card-stamp">
                    <div class="stamp-date">${stampMonth}/${stampDay}</div>
                    <div class="stamp-label">${msg.topicTag ? '#' + msg.topicTag : 'Heart'}</div>
                </div>
                <div class="card-body">
                    <div class="card-greeting">è‡´ï¼š${msg.target}</div>
                    <div class="card-content ${sizeClass} ${hasNewline ? 'has-newline' : ''}">${contentHtml}</div>
                </div>
                <div class="card-footer">
                    <div class="card-tag tag-${msg.tag}">${msg.tag}</div>
                    <div class="card-author">${msg.displayName}</div>
                </div>
            `;








            board.appendChild(card);

            // é—œéµå­—ç‰¹æ•ˆè‡ªå‹•è§¸ç™¼ (å‡ºç¾ 1 ç§’å¾ŒåŸ·è¡Œ)
            if (card.dataset.autoEffect === "true") {
                setTimeout(() => {
                    createParticles(card.querySelector('.card-content'), card.dataset.effectMode, card.dataset.effectIcon);
                }, 1000);
            }



            // å¡ç‰‡ç”Ÿå‘½é€±æœŸï¼š10 ç§’å¾Œå›æ”¶ (å«æ·¡å‡º)
            // å¡ç‰‡ç”Ÿå‘½é€±æœŸï¼šéš¨æ©Ÿ 12~20 ç§’ (é”æˆ 3~5 å¼µçš„éš¨æ©Ÿæ³¢å‹•æ„Ÿ)
            // æ•¸å­¸åŸç†ï¼š12s/4s = 3å¼µ, 20s/4s = 5å¼µ
            const lifeTime = Math.floor(Math.random() * (20000 - 12000 + 1) + 12000);

            setTimeout(() => {
                card.classList.add('fade-out');
                setTimeout(() => {
                    card.remove();
                    displayingIndexes.delete(index);

                    // é—œéµï¼šå¡ç‰‡æ¶ˆå¤±å¾Œï¼Œä¸»å‹•è§¸ç™¼ä¸€æ¬¡è£œä½æª¢æŸ¥
                    // ä¾éœ€æ±‚ï¼šæ¶ˆå¤±å¾Œ 4 ç§’æ‰è£œä½
                    setTimeout(() => rotateMessages(), 4000);
                }, 1000);
            }, lifeTime);
        }



        // --- Google ç™»å…¥è™•ç† ---
        function handleCredentialResponse(response) {
            const payload = parseJwt(response.credential);
            const email = payload.email;
            const domain = "@stweb.jcjh.tp.edu.tw";

            if (!email.endsWith(domain)) {
                showModal('ç¶²åŸŸéŒ¯èª¤', `æŠ±æ­‰ï¼Œæœ¬ç•™è¨€æ¿åƒ…é™å»ºæˆåœ‹ä¸­å­¸ç”Ÿå¸³è™Ÿ (${domain}) ä½¿ç”¨ã€‚`, 'error');
                return;
            }

            currentUserEmail = email;
            currentUserName = payload.name;

            const loginContainer = document.getElementById('google-login-container');
            loginContainer.innerHTML = `<p style="color: #27ae60; font-weight: bold;">âœ… å·²èªè­‰ï¼š${currentUserName}</p>`;

            document.querySelector('.btn-submit[onclick="submitDraft()"]').textContent = "ç¢ºèªé€å‡ºç•™è¨€";
        }

        function parseJwt(token) {
            var base64Url = token.split('.')[1];
            var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            var jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function (c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            return JSON.parse(jsonPayload);
        }

        // --- é€å‡ºç•™è¨€ ---
        async function submitDraft() {
            // æ±ºå®šèº«ä»½ï¼šè‹¥ç‚ºå­¸æ ¡æ¨¡å¼ä¸”æœªç™»å…¥ï¼Œå‰‡æ“‹ä¸‹ï¼›è‹¥ç‚ºè¨ªå®¢æ¨¡å¼ä¸”æœªç™»å…¥ï¼Œå‰‡å¥—ç”¨ visitor é‚è¼¯
            if (currentSubmissionMode === 'school' && !currentUserEmail) {
                showModal('æç¤º', 'è«‹å…ˆä½¿ç”¨å­¸æ ¡ Google å¸³è™Ÿç™»å…¥ï¼Œä»¥ç¶­è­·æ ¡åœ’ç•™è¨€ç’°å¢ƒã€‚', 'warning');
                return;
            }

            const content = document.getElementById('content').value;
            const target = document.getElementById('target').value;

            // æ•æ„Ÿè©æª¢æ¸¬
            if (containsSensitiveWords(content) || containsSensitiveWords(target)) {
                showModal('å…§å®¹ä¸ç•¶', 'æ‚¨çš„ç•™è¨€åŒ…å«ä¸æ°ç•¶çš„ç”¨èªï¼Œè«‹ä¿®æ”¹å¾Œé‡æ–°é€å‡ºã€‚è®“æˆ‘å€‘ä¸€èµ·ç¶­è­·å‹å–„çš„æ ¡åœ’ç’°å¢ƒ ğŸ’', 'warning');
                return;
            }

            const isAnonymous = document.getElementById('isAnonymous').checked;
            const anonymousName = document.getElementById('anonymousName')?.value?.trim() || '';

            const data = {
                target: target,
                tag: document.getElementById('tag').value,
                content: content,
                isAnonymous: isAnonymous,
                anonymousName: isAnonymous ? (anonymousName || 'å°å¤©ä½¿') : '',
                topicTag: document.getElementById('topicTag')?.value || '',
                email: currentUserEmail,
                name: currentUserName
            };

            if (!data.target || !data.content) {
                showModal('å¡«å¯«æœªå®Œæˆ', 'è«‹å¡«å¯«ç•™è¨€å°è±¡èˆ‡å…§å®¹ã€‚', 'warning');
                return;
            }

            const btn = document.querySelector('.btn-submit[onclick="submitDraft()"]');
            btn.disabled = true;
            btn.textContent = "å‚³é€ä¸­...";

            const res = await fetchAPI('submitMessage', data);

            if (res && res.status === "success") {
                const isPostOnly = document.body.classList.contains('post-only-mode');

                if (isPostOnly) {
                    // æŠ•ç¨¿æ¨¡å¼ï¼šä¸é—œé–‰è¦–çª—ï¼Œæ”¹ç‚ºé¡¯ç¤ºæ„Ÿè¬ç•«é¢
                    const modalContent = document.querySelector('#postModal .modal-content');
                    modalContent.innerHTML = `
                        <div style="text-align: center; padding: 2rem 1rem;">
                            <div class="pulsate" style="font-size: 4rem; color: #27ae60; margin-bottom: 1.5rem;">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <h2 style="color: var(--warm-brown); margin-bottom: 1rem;">æŠ•ç¨¿æˆåŠŸï¼</h2>
                            <p style="font-size: 1.1rem; color: #666; line-height: 1.6; margin-bottom: 2rem;">
                                ç•™è¨€å¯©æ ¸å¾Œå°‡é¡¯ç¤ºæ–¼<br><strong style="color: var(--primary-coral); font-size: 1.3rem;">ã€Œæ–¼åº­é›»è¦–ç‰†ã€</strong>
                            </p>
                            <button class="btn-submit" onclick="location.reload()" style="width: auto; padding: 0.8rem 2.5rem;">
                                <i class="fas fa-feather-alt"></i> å†å¯«ä¸€å‰‡
                            </button>
                        </div>
                    `;
                    showModal('é€å‡ºæˆåŠŸ', 'æ„Ÿè¬æ‚¨çš„æº«æš–æŠ•ç¨¿ï¼', 'success');
                } else {
                    showModal('é€å‡ºæˆåŠŸ', res.message, 'success');
                    closeModal('postModal');
                    document.getElementById('postForm').reset();
                }
            } else {
                showModal('å¤±æ•—', 'ç•™è¨€é€å‡ºå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ã€‚', 'error');
            }

            btn.disabled = false;
            btn.textContent = "ç¢ºèªé€å‡ºç•™è¨€";
        }

        // --- ç®¡ç†å¾Œå°è™•ç† ---
        let adminRawData = [];
        let currentTab = "å¾…å¯©æ ¸";
        let currentAdminLimit = 20; // é è¨­é¡¯ç¤ºæ•¸é‡
        const ADMIN_PAGE_SIZE = 20; // æ¯æ¬¡å±•é–‹æ•¸é‡

        async function doAdminLogin() {
            const password = document.getElementById('adminPassword').value;
            // ä¿®æ­£ï¼šfetchAPI çš„åƒæ•¸èª¿ç”¨æ–¹å¼èˆ‡ loadAdminMessages ä¿æŒä¸€è‡´
            const res = await fetchAPI('adminGetMessages', { password });

            if (res && res.messages) {
                localStorage.setItem('admin_password', password);
                renderAdminUI(res);
            } else {
                showModal('éŒ¯èª¤', res.error || 'å¯†ç¢¼ä¸æ­£ç¢ºã€‚', 'error');
            }
        }

        function renderAdminUI(data) {
            // ä¿®æ­£ï¼šå¾å›å‚³ç‰©ä»¶ä¸­æå– messages é™£åˆ—
            adminRawData = data.messages || [];
            document.getElementById('admin-login-ui').style.display = 'none';
            document.getElementById('admin-panel').style.display = 'block';

            // åŒæ­¥æ›´æ–°èˆ‡é¡¯ç¤ºè©¦ç®—è¡¨é€£çµ
            const sheetLink = document.getElementById('admin-sheet-link');
            if (sheetLink) {
                if (data.sheetUrl) sheetLink.href = data.sheetUrl;
                sheetLink.style.display = 'inline-block';
            }

            // åŒæ­¥æ¨™ç±¤è¨­å®š
            if (data.topicConfig) {
                topicConfig = data.topicConfig;
                applyTopicConfig();
                if (document.getElementById('admin-topic-panel').style.display === 'block') {
                    renderTopicManagementUI();
                }
            }

            // åŒæ­¥æ¸¬è©¦æ¨¡å¼ç‹€æ…‹
            const testToggle = document.getElementById('toggleInternalTest');
            if (testToggle) testToggle.checked = !!data.isInternalTest;

            // åŒæ­¥æŠ•ç¨¿æ¨¡å¼
            const submissionModeSelect = document.getElementById('submissionModeSelect');
            if (submissionModeSelect && data.submissionMode) {
                submissionModeSelect.value = data.submissionMode;
                currentSubmissionMode = data.submissionMode;
            }

            switchTab(currentTab);
        }

        function switchTab(tab) {
            currentTab = tab;
            currentAdminLimit = ADMIN_PAGE_SIZE; // åˆ‡æ›æ¨™ç±¤æ™‚é‡ç½®é¡¯ç¤ºæ•¸é‡
            document.querySelectorAll('.tab-btn').forEach(b => {
                const btnText = b.textContent.trim();
                const isActive = (btnText === tab ||
                    (tab === 'é€šé' && btnText === 'é€šé') ||
                    (tab === 'é§å›' && btnText === 'é§å›') ||
                    (tab === 'å·²ä¸‹æ¶' && btnText === 'ä¸‹æ¶') ||
                    (tab === 'æ¨™ç±¤ç®¡ç†' && btnText === 'æ¨™ç±¤åº«') ||
                    (tab === 'ç‰¹æ•ˆè¨­å®š' && btnText === 'ç‰¹æ•ˆéˆ•') ||
                    (tab === 'ç³»çµ±è¨­å®š' && btnText === 'è¨­å®š') ||
                    (tab === 'è·‘é¦¬ç‡ˆç®¡ç†' && btnText === 'è·‘é¦¬ç‡ˆ'));
                b.classList.toggle('active', isActive);
            });

            // åˆ‡æ›é¢ç‰ˆ
            const msgPanel = document.getElementById('tab-content-list');
            const annPanel = document.getElementById('admin-ann-panel');
            const settingsPanel = document.getElementById('admin-settings-panel');
            const effectPanel = document.getElementById('admin-effect-panel');
            const topicPanel = document.getElementById('admin-topic-panel');

            // å…ˆéš±è—æ‰€æœ‰é¢æ¿
            msgPanel.style.display = 'none';
            annPanel.style.display = 'none';
            settingsPanel.style.display = 'none';
            if (effectPanel) effectPanel.style.display = 'none';
            if (topicPanel) topicPanel.style.display = 'none';

            if (tab === 'è·‘é¦¬ç‡ˆç®¡ç†') {
                annPanel.style.display = 'block';
                renderAnnManagementUI();
            } else if (tab === 'æ¨™ç±¤ç®¡ç†') {
                if (annPanel) annPanel.style.display = 'none';
                if (msgPanel) msgPanel.style.display = 'none';
                document.getElementById('admin-topic-panel').style.display = 'block';
                renderTopicManagementUI();
            } else if (tab === 'ç‰¹æ•ˆè¨­å®š') {
                if (effectPanel) effectPanel.style.display = 'block';
                renderEffectEditor();
            } else if (tab === 'ç³»çµ±è¨­å®š') {
                settingsPanel.style.display = 'block';
            } else {
                msgPanel.style.display = 'block';
                renderMessageManagementUI(tab);
            }
        }

        function renderMessageManagementUI(tab) {
            const list = document.getElementById('admin-msg-list');
            list.innerHTML = '';
            document.getElementById('batch-actions-bar').style.display = 'flex';

            // æ‰¹æ¬¡æŒ‰éˆ•å‹•æ…‹èª¿æ•´é¡è‰² (å¦‚æœæ˜¯é§å›æˆ–ä¸‹æ¶åˆ†é ï¼ŒæŒ‰éˆ•åŠŸèƒ½ä¸è®Šä½†é¡¯ç¤ºä¸Šæ›´ç›´è¦º)
            const approveBtn = document.querySelector('.btn-approve');
            const rejectBtn = document.querySelector('.btn-reject');
            if (tab === 'é€šé') {
                approveBtn.style.display = 'none';
                rejectBtn.textContent = 'æ‰¹æ¬¡é§å›';
            } else if (tab === 'é§å›') {
                approveBtn.style.display = 'inline-block';
                approveBtn.textContent = 'æ‰¹æ¬¡é€šé';
                rejectBtn.style.display = 'none';
            } else if (tab === 'å·²ä¸‹æ¶') {
                approveBtn.style.display = 'inline-block';
                approveBtn.textContent = 'é‡æ–°ä¸Šæ¶';
                rejectBtn.textContent = 'æ‰¹æ¬¡é§å›';
            } else {
                approveBtn.style.display = 'inline-block';
                approveBtn.textContent = 'æ‰¹æ¬¡é€šé';
                rejectBtn.style.display = 'inline-block';
                rejectBtn.textContent = 'æ‰¹æ¬¡é§å›';
            }

            const now = new Date().getTime();
            const twoWeeksMs = 14 * 24 * 60 * 60 * 1000;

            const filtered = adminRawData.filter(m => {
                const messageTime = new Date(m.approvalTime || m.timestamp).getTime(); // Use approvalTime for filtering
                const isExpired = (now - messageTime) > twoWeeksMs;

                if (tab === 'å·²ä¸‹æ¶') {
                    // å·²ä¸‹æ¶åˆ†é ï¼šé¡¯ç¤ºé€šéä½†å·²éæœŸçš„ç•™è¨€
                    return m.status === 'é€šé' && isExpired;
                } else if (tab === 'é€šé') {
                    // å·²é€šéåˆ†é ï¼šé¡¯ç¤ºé€šéä¸”æœªéæœŸçš„ç•™è¨€
                    return m.status === 'é€šé' && !isExpired;
                } else {
                    return m.status === tab;
                }
            });

            const hasMore = filtered.length > currentAdminLimit;
            const toShow = filtered.slice(0, currentAdminLimit);

            if (toShow.length === 0) {
                list.innerHTML = `<li style="text-align:center; padding: 2rem; color: #999;">ç›®å‰æ²’æœ‰${tab}çš„ç•™è¨€ã€‚</li>`;
                return;
            }

            toShow.forEach(m => {
                const li = document.createElement('li');
                li.className = 'admin-item';
                const msgDate = new Date(m.timestamp);
                const isExpired = (new Date().getTime() - msgDate.getTime()) > twoWeeksMs;
                const expiredBadge = (m.status === 'é€šé' && isExpired) ? `<span style="background:#eee; color:#999; padding:2px 6px; border-radius:4px; font-size:10px; margin-left:5px;">æ™‚æ•ˆå·²å±†</span>` : '';

                const dateStr = msgDate.toLocaleString('zh-TW', { month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                li.innerHTML = `
                    <input type="checkbox" class="msg-checkbox item-checkbox" value="${m.id}">
                    <div class="item-info">
                        <div class="item-meta">
                            ${dateStr} Â· <span class="item-target">${m.target}</span> Â· 
                            <span class="tag-${m.tag}" style="padding:1px 6px; border-radius:4px; font-size:10px;">${m.tag}</span>
                            ${m.topicTag ? `<span style="background:var(--primary-coral); color:white; padding:1px 6px; border-radius:4px; font-size:10px; margin-left:5px;">${m.topicTag}</span>` : ''}
                            ${expiredBadge}
                        </div>
                        <div class="item-content">${m.content}</div>
                        <div style="font-size:0.75rem; color:#888; margin-top:2px;">
                            é¡¯ç¤ºï¼š${m.displayName} ï½œ çœŸå¯¦ï¼š${m.realName || 'ä¸å…·å'}ï¼ˆ${m.account}ï¼‰
                        </div>
                    </div>
                    <div class="admin-actions">
                        <button class="btn-approve" style="background:#f39c12; border-color:#e67e22;" onclick="editMessage('${m.id}')" title="ç·¨è¼¯å…§å®¹"><i class="fas fa-edit"></i></button>
                        ${(m.status !== 'é€šé' || (isExpired && !m.isPinned)) ? `<button class="btn-approve" onclick="updateStatus('${m.id}', 'é€šé')" title="é‡æ–°ä¸Šæ¶">âœ“</button>` : ''}
                        ${m.status !== 'é§å›' ? `<button class="btn-reject" onclick="updateStatus('${m.id}', 'é§å›')">âœ—</button>` : ''}
                    </div>
                `;
                list.appendChild(li);
            });

            // å¦‚æœé‚„æœ‰æ›´å¤šç•™è¨€ï¼Œæ¸²æŸ“ã€Œé¡¯ç¤ºæ›´å¤šã€æŒ‰éˆ•
            if (hasMore) {
                const loadMoreLi = document.createElement('li');
                loadMoreLi.style.cssText = 'padding: 1rem; text-align: center; list-style: none;';
                loadMoreLi.innerHTML = `
                    <button onclick="loadMoreAdminMessages()" class="tab-btn" style="margin: 0 auto; padding: 10px 30px; border-radius: 20px; border: 1px dashed var(--primary-coral); color: var(--primary-coral); background: rgba(231, 103, 103, 0.05);">
                        é¡¯ç¤ºæ›´å¤šç•™è¨€ (é‚„æœ‰ ${filtered.length - currentAdminLimit} å‰‡)
                    </button>
                `;
                list.appendChild(loadMoreLi);
            }
        }

        function loadMoreAdminMessages() {
            currentAdminLimit += ADMIN_PAGE_SIZE;
            renderMessageManagementUI(currentTab);
        }


        async function batchUpdate(status) {
            const checkboxes = document.querySelectorAll('.msg-checkbox:checked');
            const ids = Array.from(checkboxes).map(cb => cb.value);
            if (ids.length === 0) {
                showModal('æç¤º', 'è«‹å…ˆå‹¾é¸è¦è™•ç†çš„ç•™è¨€ã€‚', 'info');
                return;
            }

            const password = localStorage.getItem('admin_password');
            let successCount = 0;

            Swal.fire({ title: 'æ‰¹æ¬¡è™•ç†ä¸­...', allowOutsideClick: false, didOpen: () => { Swal.showLoading(); } });

            for (const id of ids) {
                const res = await fetchAPI('updateStatus', { id, status, password });
                if (res && res.status === "success") successCount++;
            }

            Swal.close();
            showModal('å®Œæˆ', `å·²æˆåŠŸè™•ç† ${successCount} å‰‡ç•™è¨€ã€‚`, 'success');
            loadAdminMessages(); // é‡æ–°æ•´ç†è³‡æ–™
            loadMessages(); // å‰å°æ›´æ–°
        }

        async function loadAdminMessages() {
            const password = localStorage.getItem('admin_password');
            if (!password) return;

            const res = await fetchAPI('adminGetMessages', { password });
            if (res && res.messages) {
                adminRawData = res.messages;

                // åŒæ­¥æ¸¬è©¦æ¨¡å¼ç‹€æ…‹ï¼ˆç¢ºä¿åœ¨éé¦–æ¬¡ç™»å…¥æ™‚ä¹Ÿèƒ½æ›´æ–° Checkboxï¼‰
                const testToggle = document.getElementById('toggleInternalTest');
                if (testToggle && typeof res.isInternalTest !== 'undefined') {
                    testToggle.checked = !!res.isInternalTest;
                }

                // åŒæ­¥æŠ•ç¨¿æ¨¡å¼
                const submissionModeSelect = document.getElementById('submissionModeSelect');
                if (submissionModeSelect && res.submissionMode) {
                    submissionModeSelect.value = res.submissionMode;
                    currentSubmissionMode = res.submissionMode;
                }

                switchTab(currentTab);
            } else if (res && res.error) {
                showModal('éŒ¯èª¤', res.error, 'error');
                // If there's an error, ensure the login UI is visible
                document.getElementById('admin-login-ui').style.display = 'block';
                document.getElementById('admin-panel').style.display = 'none';
                const loadingHint = document.getElementById('admin-loading-hint');
                if (loadingHint) loadingHint.style.display = 'none';
            }
        }

        function logoutAdmin() {
            localStorage.removeItem('admin_password');
            location.reload();
        }

        function toggleSelectAll(source) {
            const checkboxes = document.querySelectorAll('.msg-checkbox');
            checkboxes.forEach(cb => cb.checked = source.checked);
        }

        async function updateStatus(id, newStatus) {
            const password = localStorage.getItem('admin_password');
            const res = await fetchAPI('updateStatus', { id, status: newStatus, password });
            if (res && res.status === "success") {
                loadAdminMessages();
                loadMessages();
            }
        }

        async function editMessage(id) {
            const msg = adminRawData.find(m => m.id === id);
            if (!msg) return;

            // æº–å‚™æ¨™ç±¤ä¸‹æ‹‰é¸å–® HTML
            const library = topicConfig.library ? topicConfig.library.split('\n').map(t => t.trim()).filter(t => t) : [];
            let topicOptionsHTML = '<option value="">(ç„¡)</option>';
            library.forEach(t => {
                topicOptionsHTML += `<option value="${t}" ${msg.topicTag === t ? 'selected' : ''}>${t}</option>`;
            });

            const { value: formValues } = await Swal.fire({
                title: 'ç·¨è¼¯ç•™è¨€å…§å®¹',
                html:
                    `<div style="text-align:left; font-size:0.9rem;">` +
                    `<label>ç•™è¨€å…§å®¹ï¼š</label>` +
                    `<textarea id="swal-content" class="swal2-textarea" style="width:100%; height:100px; margin:10px 0;">${msg.content}</textarea>` +
                    `<label>é¡åˆ¥ï¼š</label>` +
                    `<select id="swal-tag" class="swal2-select" style="width:100%; margin:10px 0;">
                        <option value="é¼“å‹µ" ${msg.tag === 'é¼“å‹µ' ? 'selected' : ''}>ğŸ’ª é¼“å‹µ</option>
                        <option value="è®šç¾" ${msg.tag === 'è®šç¾' ? 'selected' : ''}>âœ¨ è®šç¾</option>
                        <option value="é—œå¿ƒ" ${msg.tag === 'é—œå¿ƒ' ? 'selected' : ''}>ğŸ«‚ é—œå¿ƒ</option>
                        <option value="æ„Ÿè¬" ${msg.tag === 'æ„Ÿè¬' ? 'selected' : ''}>ğŸ‚ æ„Ÿè¬</option>
                        <option value="ç¥ç¦" ${msg.tag === 'ç¥ç¦' ? 'selected' : ''}>ğŸˆ ç¥ç¦</option>
                    </select>` +
                    `<label>æ¨™ç±¤ï¼š</label>` +
                    `<select id="swal-topic" class="swal2-select" style="width:100%; margin:10px 0;">
                        ${topicOptionsHTML}
                    </select>` +
                    `<label>é¡¯ç¤ºåç¨±ï¼š</label>` +
                    `<input id="swal-displayname" class="swal2-input" style="width:100%; margin:10px 0;" value="${msg.displayName}">` +
                    `</div>`,
                focusConfirm: false,
                showCancelButton: true,
                confirmButtonText: 'ç¢ºèªä¿®æ”¹',
                cancelButtonText: 'å–æ¶ˆ',
                preConfirm: () => {
                    return {
                        content: document.getElementById('swal-content').value,
                        tag: document.getElementById('swal-tag').value,
                        topicTag: document.getElementById('swal-topic').value,
                        displayName: document.getElementById('swal-displayname').value
                    }
                }
            });

            if (formValues) {
                const password = localStorage.getItem('admin_password');
                Swal.fire({ title: 'ä¿®æ”¹ä¸­...', didOpen: () => Swal.showLoading() });

                const res = await fetchAPI('updateMessage', {
                    id,
                    content: formValues.content,
                    tag: formValues.tag,
                    topicTag: formValues.topicTag,
                    displayName: formValues.displayName,
                    password
                });

                if (res && res.status === "success") {
                    showModal('æˆåŠŸ', 'ç•™è¨€å…§å®¹å·²æ›´æ–°', 'success');
                    loadAdminMessages();
                    loadMessages();
                }
            }
        }

        async function togglePin(id, isPinned) {
            const password = localStorage.getItem('admin_password');
            const res = await fetchAPI('updatePin', { id, isPinned, password });
            if (res && res.status === "success") {
                loadAdminMessages();
                loadMessages();
                showModal('å·²æ›´æ–°', isPinned ? 'å·²æˆåŠŸé‡˜é¸ç‚ºå…¬å‘Š' : 'å·²å–æ¶ˆé‡˜é¸', 'success');
            }
        }

        // --- è·‘é¦¬ç‡ˆç®¡ç†ç·¨è¼¯é‚è¼¯ ---
        function renderAnnManagementUI() {
            const container = document.getElementById('ann-list-editor');
            container.innerHTML = '';

            if (currentAnnouncements.length === 0) {
                addAnnEditorRow(""); // é è¨­çµ¦ä¸€å€‹ç©ºè¡Œ
            } else {
                currentAnnouncements.forEach(ann => addAnnEditorRow(ann.content));
            }
        }

        function addAnnEditorRow(content = "") {
            const container = document.getElementById('ann-list-editor');
            const div = document.createElement('div');
            div.className = 'ann-editor-item';
            div.innerHTML = `
                <div class="ann-editor-controls">
                    <button class="btn-sort" onclick="moveAnnRow(this, -1)" title="ä¸Šç§»"><i class="fas fa-chevron-up"></i></button>
                    <button class="btn-sort" onclick="moveAnnRow(this, 1)" title="ä¸‹ç§»"><i class="fas fa-chevron-down"></i></button>
                </div>
                <textarea class="ann-input" placeholder="è«‹è¼¸å…¥å…¬å‘Šå…§å®¹...">${content}</textarea>
                <button class="btn-reject" onclick="this.parentElement.remove()" style="padding: 10px 12px; height: auto;" title="åˆªé™¤"><i class="fas fa-trash"></i></button>
            `;
            container.appendChild(div);
        }

        function moveAnnRow(btn, direction) {
            const row = btn.closest('.ann-editor-item');
            if (!row) return;

            if (direction === -1) {
                const prev = row.previousElementSibling;
                if (prev) row.parentElement.insertBefore(row, prev);
            } else {
                const next = row.nextElementSibling;
                if (next) row.parentElement.insertBefore(next, row);
            }
        }

        async function saveAnnouncements() {
            const inputs = document.querySelectorAll('.ann-input');
            const announcements = Array.from(inputs)
                .map(i => ({ content: i.value.trim() }))
                .filter(a => a.content !== "");

            const password = localStorage.getItem('admin_password');
            Swal.fire({ title: 'æ›´æ–°å…¬å‘Šä¸­...', didOpen: () => Swal.showLoading() });

            const res = await fetchAPI('updateAnnouncements', { announcements, password });

            if (res && res.status === "success") {
                showModal('æˆåŠŸ', 'å…¬å‘Šå·²åŒæ­¥è‡³è·‘é¦¬ç‡ˆ', 'success');
                loadAnnouncements(); // å³æ™‚è¼‰å…¥å‰å°é¡¯ç¤º
            } else {
                Swal.close();
            }
        }

        // --- ç‰¹æ•ˆè¦å‰‡ç®¡ç† ---
        function renderEffectEditor() {
            const container = document.getElementById('effect-list-editor');
            if (!container) return;
            container.innerHTML = '';

            if (!currentEffects || currentEffects.length === 0) {
                container.innerHTML = '<div style="color:#aaa; text-align:center; padding:20px;">ç›®å‰æ²’æœ‰è¨­å®šä»»ä½•è¦å‰‡</div>';
            } else {
                currentEffects.forEach((eff, index) => {
                    const div = document.createElement('div');
                    div.className = 'ann-editor-item';
                    div.style.borderLeft = `4px solid var(--primary-coral)`;
                    div.innerHTML = `
                        <div style="flex:1; font-weight:bold; color:#555;">${eff.keyword}</div>
                        <div style="width:40px; text-align:center;">${eff.icon}</div>
                        <div style="width:80px; font-size:0.85rem; color:#888;">${eff.mode}</div>
                        <div style="display:flex; gap:5px;">
                            <button class="btn-approve" onclick="createParticles(this, '${eff.mode}', '${eff.icon}')" style="padding: 6px 10px; height: auto;" title="é è¦½ç‰¹æ•ˆ"><i class="fas fa-play"></i></button>
                            <button class="btn-approve" onclick="editEffectRule(${index})" style="padding: 6px 10px; height: auto; background:#f39c12; border-color:#f39c12;" title="ç·¨è¼¯"><i class="fas fa-edit"></i></button>
                            <button class="btn-reject" onclick="removeEffectRule(${index})" style="padding: 6px 10px; height: auto;" title="åˆªé™¤"><i class="fas fa-trash"></i></button>
                        </div>
                    `;
                    container.appendChild(div);
                });
            }
        }

        function addEffectRule() {
            const kInput = document.getElementById('new-effect-keyword');
            const iInput = document.getElementById('new-effect-icon');
            const mInput = document.getElementById('new-effect-mode');
            const editIdxInput = document.getElementById('edit-effect-index');

            const keyword = kInput.value.trim();
            const icon = iInput.value.trim();
            const mode = mInput.value;
            const editIdx = parseInt(editIdxInput.value);

            if (!keyword || !icon) {
                showModal('æç¤º', 'è«‹è¼¸å…¥é—œéµå­—èˆ‡åœ–ç¤º', 'info');
                return;
            }

            if (!currentEffects) currentEffects = [];

            if (editIdx >= 0) {
                currentEffects[editIdx] = { keyword, icon, mode };
                editIdxInput.value = "-1";
                document.getElementById('btn-add-effect').textContent = "æ–°å¢";
            } else {
                currentEffects.push({ keyword, icon, mode });
            }

            // æ¸…ç©ºè¼¸å…¥æ¡†
            kInput.value = '';
            iInput.value = '';

            renderEffectEditor();
        }

        function editEffectRule(index) {
            const eff = currentEffects[index];
            document.getElementById('new-effect-keyword').value = eff.keyword;
            document.getElementById('new-effect-icon').value = eff.icon;
            document.getElementById('new-effect-mode').value = eff.mode;
            document.getElementById('edit-effect-index').value = index;
            document.getElementById('btn-add-effect').textContent = "å„²å­˜ä¿®æ”¹";

            // æ²å‹•åˆ°è¼¸å…¥å€åŸŸ
            document.getElementById('new-effect-keyword').focus();
        }

        function previewCurrentEffect() {
            const icon = document.getElementById('new-effect-icon').value.trim();
            const mode = document.getElementById('new-effect-mode').value;
            const btn = event.currentTarget;

            if (!icon) {
                showModal('æç¤º', 'è«‹å…ˆè¼¸å…¥ä¸€å€‹ Emoji åœ–ç¤ºå¾Œå†é è¦½', 'info');
                return;
            }

            // é—œéµä¿®æ­£ï¼šé–å®šå…¨å±€ Body æ²è»¸ï¼Œé˜²æ­¢é è¦½æ™‚è¦–çª—è·³å‹•
            const originalOverflow = document.body.style.overflow;
            document.body.style.overflow = 'hidden';

            createParticles(btn, mode, icon);

            setTimeout(() => {
                document.body.style.overflow = originalOverflow;
            }, 3000);
        }

        function removeEffectRule(index) {
            currentEffects.splice(index, 1);
            renderEffectEditor();
        }

        async function saveKeywordEffects() {
            const password = localStorage.getItem('admin_password');
            Swal.fire({ title: 'å„²å­˜ç‰¹æ•ˆè¨­å®šä¸­...', didOpen: () => Swal.showLoading() });

            const res = await fetchAPI('updateKeywordEffects', { effects: currentEffects, password });

            if (res && res.status === "success") {
                showModal('æˆåŠŸ', 'ç‰¹æ•ˆè¨­å®šå·²æ›´æ–°', 'success');
            } else {
                Swal.close();
                showModal('å¤±æ•—', res.error || 'æ›´æ–°å¤±æ•—', 'error');
            }
        }

        // --- é—œéµå­—ç‰¹æ•ˆå¼•æ“ ---
        async function loadKeywordEffects() {
            const res = await fetchAPI('getKeywordEffects');
            if (res && Array.isArray(res)) {
                currentEffects = res;
                console.log("ç‰¹æ•ˆè¦å‰‡å·²è¼‰å…¥", currentEffects.length);
            }
        }

        // --- Canvas ç‰¹æ•ˆå¼•æ“ (æ›¿ä»£èˆŠæœ‰ DOM ç²’å­) ---
        class EffectEngine {
            constructor() {
                this.canvas = document.getElementById('effectCanvas');
                this.ctx = this.canvas.getContext('2d', { alpha: true });
                this.particles = [];
                this.lastTime = performance.now();
                this.isRunning = false;
                this.dpr = window.devicePixelRatio || 1;
                // æ•ˆèƒ½å„ªåŒ–ï¼šå°æ¥µé«˜è§£æåº¦é€²è¡Œé™æ¡æ¨£
                this.scale = this.dpr > 2 ? 0.75 : 1.0;

                this.resize();
                window.addEventListener('resize', () => this.resize());
                this.loop = this.loop.bind(this);
            }

            resize() {
                const w = window.innerWidth;
                const h = window.innerHeight;
                this.canvas.width = w * this.dpr * this.scale;
                this.canvas.height = h * this.dpr * this.scale;
                this.canvas.style.width = w + 'px';
                this.canvas.style.height = h + 'px';
                this.ctx.scale(this.dpr * this.scale, this.dpr * this.scale);
            }

            addParticles(element, mode, icon) {
                const rect = element ? element.getBoundingClientRect() : { top: 0, left: 0, width: window.innerWidth, height: window.innerHeight };
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;

                let count = 12;
                if (mode === 'firework') count = 1;
                else if (mode === 'snow') count = 20;
                else if (mode === 'sparkle') count = 15;
                else if (mode === 'rain') count = 6; // æ¸›å°‘é›¨æ»´æ•¸é‡ï¼Œé¿å…ç•«é¢éæ–¼æ“æ“ 

                for (let i = 0; i < count; i++) {
                    const p = {
                        x: centerX,
                        y: centerY,
                        mode: mode,
                        icon: icon,
                        size: 15 + Math.random() * 20,
                        alpha: 1,
                        vx: (Math.random() - 0.5) * 8,
                        vy: (Math.random() - 0.5) * 8,
                        life: 1,
                        decay: 0.01 + Math.random() * 0.02,
                        angle: Math.random() * Math.PI * 2,
                        rotation: Math.random() * Math.PI * 2,
                        rotSpeed: (Math.random() - 0.5) * 0.1
                    };

                    if (mode === 'snow') {
                        p.x = Math.random() * window.innerWidth;
                        p.y = -20;
                        p.vx = (Math.random() - 0.5) * 2;
                        p.vy = 2 + Math.random() * 3;
                        p.decay = 0.003;
                    } else if (mode === 'rain') {
                        // ç¯„åœè¦†è“‹æ•´å‰‡è²¼æ–‡ï¼Œä¸¦ç¨å¾®å‘å¤–å»¶ä¼¸
                        const padding = 20;
                        p.x = (rect.left - padding) + Math.random() * (rect.width + padding * 2);
                        p.y = rect.top - 20;
                        p.vx = 0.1; // æ¸›æ…¢æ©«ç§»
                        p.vy = 1.2 + Math.random() * 0.8; // æ¥µè‡´æ…¢é€Ÿ (åŸç‚º 3 + random*2)
                        p.decay = 0.007; // å¢åŠ ç”Ÿå‘½é€±æœŸè®“æ…¢é€Ÿé›¨æ»´èƒ½è½åˆ°ç›®çš„åœ°
                        p.limitY = rect.bottom + 40; // å…è¨±è½åˆ°è²¼æ–‡ä¸‹æ–¹ä¸€é»é»
                    } else if (mode === 'float') {
                        p.x = rect.left + Math.random() * rect.width;
                        p.y = rect.bottom;
                        p.vx = (Math.random() - 0.5) * 1;
                        p.vy = -(1 + Math.random() * 1.5);
                        p.decay = 0.008;
                    } else if (mode === 'firework') {
                        this.createFirework(centerX, rect.bottom, icon);
                        return;
                    }

                    this.particles.push(p);
                }

                if (!this.isRunning) {
                    this.isRunning = true;
                    this.lastTime = performance.now();
                    requestAnimationFrame(this.loop);
                }
            }

            createFirework(x, y, icon) {
                const p = {
                    x, y, icon, mode: 'firework-up',
                    vx: 0, vy: -12, alpha: 1, life: 1, size: 25, decay: 0.02
                };
                this.particles.push(p);
                if (!this.isRunning) {
                    this.isRunning = true;
                    this.lastTime = performance.now();
                    requestAnimationFrame(this.loop);
                }
            }

            explode(x, y, icon) {
                for (let i = 0; i < 24; i++) {
                    const angle = Math.random() * Math.PI * 2;
                    const spd = 2 + Math.random() * 6;
                    this.particles.push({
                        x, y, icon, mode: 'burst',
                        vx: Math.cos(angle) * spd,
                        vy: Math.sin(angle) * spd,
                        size: 10 + Math.random() * 15,
                        alpha: 1, life: 1, decay: 0.02,
                        rotation: Math.random() * Math.PI * 2
                    });
                }
            }

            loop(time) {
                if (this.particles.length === 0) {
                    this.isRunning = false;
                    this.ctx.clearRect(0, 0, this.canvas.width / (this.dpr * this.scale), this.canvas.height / (this.dpr * this.scale));
                    return;
                }

                const dt = Math.min(2, (time - this.lastTime) / 16.6);
                this.lastTime = time;
                this.ctx.clearRect(0, 0, this.canvas.width / (this.dpr * this.scale), this.canvas.height / (this.dpr * this.scale));

                for (let i = this.particles.length - 1; i >= 0; i--) {
                    const p = this.particles[i];
                    p.x += p.vx * dt;
                    p.y += p.vy * dt;
                    p.life -= p.decay * dt;
                    p.rotation += (p.rotSpeed || 0.05) * dt;

                    if (p.mode === 'firework-up') {
                        if (p.vy < 0) p.vy += 0.22 * dt;
                        if (p.life < 0.25) {
                            this.explode(p.x, p.y, p.icon);
                            p.life = 0;
                        }
                    } else if (p.mode === 'rain' && p.y > (p.limitY || 9999)) {
                        p.life = 0;
                    } else if (p.mode === 'burst' || p.mode === 'sparkle') {
                        p.vy += 0.12 * dt;
                    }

                    if (p.life <= 0) {
                        this.particles.splice(i, 1);
                        continue;
                    }

                    this.ctx.save();
                    this.ctx.globalAlpha = p.life;
                    this.ctx.translate(p.x, p.y);
                    this.ctx.rotate(p.rotation || 0);
                    this.ctx.font = `${p.size}px Arial`;
                    this.ctx.fillText(p.icon, -p.size / 2, p.size / 2);
                    this.ctx.restore();
                }

                if (this.isRunning) {
                    requestAnimationFrame(this.loop);
                }
            }
        }

        // åˆå§‹åŒ–
        const effectEngine = new EffectEngine();
        function createParticles(element, mode, icon) {
            effectEngine.addParticles(element, mode, icon);
        }

        function createExplosion(container, icon) {
            const particleCount = 12; // èª¿é™æ•¸é‡
            for (let i = 0; i < particleCount; i++) {
                const p = document.createElement('div');
                p.textContent = icon;
                p.className = 'particle';
                p.style.fontSize = (10 + Math.random() * 10) + 'px';

                p.style.left = '50%';
                p.style.top = '20%';

                const rad = Math.random() * Math.PI * 2;
                const dist = 40 + Math.random() * 100;
                const dx = Math.cos(rad) * dist + 'px';
                const dy = Math.sin(rad) * dist + 'px';

                p.style.setProperty('--ex', dx);
                p.style.setProperty('--ey', dy);

                p.style.animation = `explode 0.8s ease-out forwards`;
                container.appendChild(p);
            }
        }

        // --- è¨­å®šèˆ‡å·¥å…· ---
        // --- ç”Ÿæˆå­¸ç”Ÿå¯«ç•™è¨€å°ˆç”¨åˆ†äº«é€£çµ ---
        function generateWriteShareLink() {
            const area = document.getElementById('write-share-area');
            const baseUrl = window.location.href.split('?')[0];
            const writeShareUrl = `${baseUrl}?write=true`;

            // é¡¯ç¤ºå€åŸŸ
            area.style.display = 'block';
            document.getElementById('writeShareUrlDisplay').value = writeShareUrl;

            // ç”Ÿæˆé«˜å°æ¯”åº¦çš„ QR Codeï¼ˆç¢ºä¿æƒç¢¼æˆåŠŸç‡ï¼‰
            const qrImg = document.getElementById('writeShareQrImg');
            if (qrImg) {
                qrImg.src = `https://quickchart.io/qr?text=${encodeURIComponent(writeShareUrl)}&size=300&margin=2&dark=c23a3a&light=ffffff`;
            }

            showModal('å¯«ç•™è¨€ QR Code å·²ç”¢ç”Ÿï¼', 'æŠŠé€™å€‹ QR Code è²¼åœ¨æ•™å®¤ï¼Œå­¸ç”Ÿæƒç¢¼å°±èƒ½ç›´æ¥å¯«ç•™è¨€ï¼', 'success');
        }

        // --- è¤‡è£½å­¸ç”Ÿå¯«ç•™è¨€å°ˆç”¨é€£çµ ---
        function copyWriteShareUrl() {
            const baseUrl = window.location.href.split('?')[0];
            const writeShareUrl = `${baseUrl}?write=true`;

            // è¤‡è£½åˆ°å‰ªè²¼ç°¿
            navigator.clipboard.writeText(writeShareUrl).then(() => {
                showModal('æˆåŠŸ', 'å¯«ç•™è¨€é€£çµå·²è¤‡è£½ï¼å¯ä»¥åˆ†äº«çµ¦å­¸ç”Ÿä½¿ç”¨', 'success');
            }).catch(() => {
                // fallback æ–¹æ¡ˆ
                const tempInput = document.createElement('input');
                tempInput.value = writeShareUrl;
                document.body.appendChild(tempInput);
                tempInput.select();
                document.execCommand('copy');
                document.body.removeChild(tempInput);
                showModal('æˆåŠŸ', 'å¯«ç•™è¨€é€£çµå·²è¤‡è£½ï¼', 'success');
            });
        }


        // --- é€šç”¨ UI å‡½å¼ ---
        function showModal(title, message, type = 'info') {
            Swal.fire({
                title,
                text: message,
                icon: type,
                confirmButtonColor: '#e67e22',
                timer: 3000, // 3ç§’å¾Œè‡ªå‹•é—œé–‰
                timerProgressBar: true, // é¡¯ç¤ºé€²åº¦æ¢
                showConfirmButton: type === 'error', // éŒ¯èª¤æ™‚æ‰é¡¯ç¤ºç¢ºèªæŒ‰éˆ•ï¼Œå…¶ä»–ç‹€æ³è‡ªå‹•æ¶ˆå¤±
            });
        }

        async function openPostModal() {
            await checkSystemConfig();
            loadTopicConfig();
            const modal = document.getElementById('postModal');
            const form = document.getElementById('postForm');

            // æ ¹æ“šæ¨¡å¼èª¿æ•´ UI
            if (currentSubmissionMode === 'closed') {
                form.style.display = 'none';
                let notice = document.getElementById('closed-notice');
                if (!notice) {
                    notice = document.createElement('div');
                    notice.id = 'closed-notice';
                    notice.style.textAlign = 'center';
                    notice.style.padding = '3rem 1rem';
                    notice.innerHTML = `<div style="font-size: 3rem; color: #999; margin-bottom: 1rem;"><i class="fas fa-lock"></i></div><h3>æœ¬æ™‚æ®µæš«ä¸é–‹æ”¾æŠ•ç¨¿</h3><p>è¬è¬æ‚¨çš„ç†±æƒ…ï¼Œè«‹ç­‰å€™ä¸‹ä¸€æ¬¡æ´»å‹•é–‹å•Ÿï¼</p>`;
                    modal.querySelector('.modal-content').appendChild(notice);
                }
                notice.style.display = 'block';
            } else {
                form.style.display = 'block';
                const notice = document.getElementById('closed-notice');
                if (notice) notice.style.display = 'none';

                // èª¿æ•´å¸³è™Ÿé©—è­‰å€å¡Š
                const identitySection = document.getElementById('identity-section');
                const googleLogin = document.getElementById('google-login-container');
                const customNameContainer = document.getElementById('custom-name-container');
                const isAnonymousWrapper = document.getElementById('isAnonymous-wrapper');
                const anonymousNameLabel = document.getElementById('anonymousNameLabel');
                const anonymousNameWrapper = document.getElementById('anonymousNameWrapper');
                const anonymousNameInput = document.getElementById('anonymousName');

                if (currentSubmissionMode === 'public') {
                    if (googleLogin) googleLogin.style.display = 'none';

                    // è®“å¤–å±¤å®¹å™¨ä¹Ÿèˆ‡ä¸‹æ–¹ä¸€è‡´ (ç§»é™¤ç™½è‰²åº•è‰²èˆ‡é‚Šæ¡†)
                    if (identitySection) {
                        identitySection.style.background = 'none';
                        identitySection.style.border = 'none';
                        identitySection.style.padding = '0';
                    }

                    // è®“æ¬„ä½æ¨£å¼è·Ÿä¸‹é¢ä¸€è‡´ (ç§»é™¤èƒŒæ™¯èˆ‡è™›ç·š)
                    customNameContainer.style.background = 'none';
                    customNameContainer.style.border = 'none';
                    customNameContainer.style.padding = '0';
                    customNameContainer.style.flexDirection = 'column';
                    customNameContainer.style.alignItems = 'flex-start';

                    isAnonymousWrapper.style.display = 'none';
                    anonymousNameLabel.style.display = 'block';
                    anonymousNameWrapper.style.display = 'block';

                    document.getElementById('isAnonymous').checked = true;
                    anonymousNameInput.placeholder = "æ‚¨çš„ç¨±å‘¼ (é¸å¡«)";
                    document.querySelector('#postModal h2').textContent = "âœ¨ å¯«ä¸‹æš–å¿ƒç•™è¨€ (å¤–è³“é–‹æ”¾ä¸­)";
                } else {
                    if (googleLogin) googleLogin.style.display = 'block';

                    // æ¢å¾©åŸæœ‰çš„ç™½è‰²åº•åº§æ¨£å¼
                    if (identitySection) {
                        identitySection.style.background = '#fff';
                        identitySection.style.border = '1px solid #eee';
                        identitySection.style.padding = '0.8rem';
                    }

                    // æ¢å¾©åŸæœ‰çš„ä¸¦æ’æ¨£å¼
                    customNameContainer.style.background = 'rgba(139, 90, 43, 0.04)';
                    customNameContainer.style.border = '1px dashed rgba(139, 90, 43, 0.1)';
                    customNameContainer.style.padding = '0.5rem 0.8rem';
                    customNameContainer.style.flexDirection = 'row';
                    customNameContainer.style.alignItems = 'center';

                    isAnonymousWrapper.style.display = 'flex';
                    anonymousNameLabel.style.display = 'none';

                    // æ ¹æ“šåŸæœ¬çš„ toggle é‚è¼¯æ±ºå®š wrapper æ˜¯å¦é¡¯ç¤º
                    toggleAnonymousName();

                    anonymousNameInput.placeholder = "æ‚¨çš„ç¨±å‘¼ (é¸å¡«)";
                    document.querySelector('#postModal h2').textContent = "âœ¨ å¯«ä¸‹æš–å¿ƒç•™è¨€";
                }
            }
            modal.style.display = 'flex';
        }
        function openAdminModal() {
            const modal = document.getElementById('adminModal');
            modal.style.display = 'flex';

            const savedPwd = localStorage.getItem('admin_password');
            const loginUI = document.getElementById('admin-login-ui');
            const panelUI = document.getElementById('admin-panel');

            if (savedPwd && panelUI.style.display === 'none') {
                // å¦‚æœæœ‰è¨˜æ†¶å¯†ç¢¼ï¼Œå…ˆéš±è—ç™»å…¥ UI ä¸¦é¡¯ç¤ºè¼‰å…¥ä¸­
                loginUI.style.display = 'none';

                // æª¢æŸ¥æ˜¯å¦å·²æœ‰è¼‰å…¥æç¤ºï¼Œæ²’æœ‰å‰‡å»ºç«‹
                let loadingHint = document.getElementById('admin-loading-hint');
                if (!loadingHint) {
                    loadingHint = document.createElement('div');
                    loadingHint.id = 'admin-loading-hint';
                    loadingHint.style.textAlign = 'center';
                    loadingHint.style.padding = '3rem 1rem';
                    loadingHint.innerHTML = `
                        <div class="pulsate" style="font-size: 2rem; color: var(--primary-coral); margin-bottom: 1rem;">
                            <i class="fas fa-unlock-alt"></i>
                        </div>
                        <p style="color: #8d7b70;">åµæ¸¬åˆ°å„²å­˜çš„æ†‘è­‰ï¼Œè‡ªå‹•ç™»å…¥ä¸­...</p>
                    `;
                    document.getElementById('admin-management-ui').prepend(loadingHint);
                }
                loadingHint.style.display = 'block';

                document.getElementById('adminPassword').value = savedPwd;
                doAdminLogin().then(() => {
                    loadingHint.style.display = 'none';
                });
            } else if (!savedPwd) {
                loginUI.style.display = 'block';
                const loadingHint = document.getElementById('admin-loading-hint');
                if (loadingHint) loadingHint.style.display = 'none';
            }
        }

        function closeModal(id) {
            // åœ¨æŠ•ç¨¿å°ˆç”¨æ¨¡å¼ä¸‹ï¼Œç¦æ­¢é—œé–‰æŠ•ç¨¿è¦–çª—
            if (id === 'postModal' && document.body.classList.contains('post-only-mode')) {
                return;
            }
            document.getElementById(id).style.display = 'none';
        }

        function updateCharCount() {
            const content = document.getElementById('content').value;
            document.getElementById('charCount').textContent = `${content.length} / 60`;
        }

        async function saveSystemConfig() {
            const isInternalTest = document.getElementById('toggleInternalTest').checked;
            const submissionMode = document.getElementById('submissionModeSelect').value;
            const password = localStorage.getItem('admin_password');

            Swal.fire({ title: 'å„²å­˜è¨­å®šä¸­...', didOpen: () => Swal.showLoading() });

            const res = await fetchAPI('updateSystemConfig', { isInternalTest, submissionMode, password });

            if (res && res.status === "success") {
                showModal('æˆåŠŸ', 'ç³»çµ±è¨­å®šå·²æ›´æ–°', 'success');
                checkSystemConfig(); // ç«‹å³å¥—ç”¨è‡³å‰ç«¯é¡¯ç¤º
            } else {
                Swal.close();
            }
        }

        async function saveTopicConfig() {
            const container = document.getElementById('topic-list-container');
            const rows = container.querySelectorAll('.topic-manage-row');

            let library = [];
            let activeSubmission = [];
            let defaultWall = [];

            rows.forEach(row => {
                const tag = row.dataset.tag;
                library.push(tag);
                if (row.querySelector('.check-submit').checked) activeSubmission.push(tag);
                if (row.querySelector('.check-wall').checked) defaultWall.push(tag);
            });

            const config = {
                library: library.join('\n'),
                activeSubmissionTags: activeSubmission.join(', '),
                defaultWallTags: defaultWall.join(', ')
            };

            const password = localStorage.getItem('admin_password');
            Swal.fire({ title: 'å„²å­˜æ¨™ç±¤è¨­å®šä¸­...', didOpen: () => Swal.showLoading() });

            const res = await fetchAPI('updateTopicConfig', { config, password });
            if (res && res.status === "success") {
                topicConfig = config;
                applyTopicConfig();
                showModal('æˆåŠŸ', 'æ´»å‹•æ¨™ç±¤è¨­å®šå·²æ›´æ–°', 'success');
            } else {
                Swal.close();
            }
        }

        function renderTopicManagementUI() {
            const container = document.getElementById('topic-list-container');
            container.innerHTML = '';

            const library = topicConfig.library ? topicConfig.library.split('\n').map(t => t.trim()).filter(t => t) : [];
            const activeSubSet = new Set(topicConfig.activeSubmissionTags ? topicConfig.activeSubmissionTags.split(',').map(t => t.trim()) : []);
            const defaultWallSet = new Set(topicConfig.defaultWallTags ? topicConfig.defaultWallTags.split(',').map(t => t.trim()) : []);

            if (library.length === 0) {
                container.innerHTML = '<p style="text-align:center; padding:20px; color:#999;">ç›®å‰æ¨™ç±¤åº«ç‚ºç©ºï¼Œè«‹å¾ä¸Šæ–¹æ–°å¢ã€‚</p>';
                return;
            }

            library.forEach(tag => {
                const row = document.createElement('div');
                row.className = 'topic-manage-row';
                row.style = 'display:flex; align-items:center; background:white; padding:10px 15px; border-radius:10px; margin-bottom:8px; gap:15px; border:1px solid #eee;';
                row.dataset.tag = tag;

                const currentUrl = window.location.origin + window.location.pathname;
                const activityLink = `${currentUrl}?view=wall&tag=${encodeURIComponent(tag)}`;

                row.innerHTML = `
                    <div style="flex:1; font-weight:bold; display:flex; align-items:center; gap:8px;">
                        <a href="${activityLink}" target="_blank" title="åœ¨æ–°åˆ†é é–‹å•Ÿæ­¤æ´»å‹•é›»è¦–ç‰†" style="color:var(--primary-coral); text-decoration:none;">
                            ${tag} <i class="fas fa-external-link-alt" style="font-size:0.75rem; margin-left:3px; opacity:0.6;"></i>
                        </a>
                        <button onclick="renameTopicInLibrary('${tag}')" style="background:none; border:none; color:#999; cursor:pointer; padding:2px;" title="é‡æ–°å‘½å">
                            <i class="fas fa-edit" style="font-size:0.8rem;"></i>
                        </button>
                    </div>
                    <label style="font-size:0.8rem; display:flex; align-items:center; gap:5px; cursor:pointer;">
                        <input type="checkbox" class="check-submit" ${activeSubSet.has(tag) ? 'checked' : ''}> æŠ•ç¨¿é¡¯ç¤º
                    </label>
                    <label style="font-size:0.8rem; display:flex; align-items:center; gap:5px; cursor:pointer;">
                        <input type="checkbox" class="check-wall" ${defaultWallSet.has(tag) ? 'checked' : ''}> é›»è¦–ç‰†é è¨­
                    </label>
                    <button onclick="removeTopicFromLibrary('${tag}')" style="background:none; border:none; color:#ff7675; cursor:pointer; padding:5px;" title="åˆªé™¤">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                container.appendChild(row);
            });
        }

        async function renameTopicInLibrary(oldTag) {
            const { value: newTag } = await Swal.fire({
                title: 'é‡æ–°å‘½åæ¨™ç±¤',
                input: 'text',
                inputLabel: `å°‡ã€Œ${oldTag}ã€é‡æ–°å‘½åç‚ºï¼š`,
                inputValue: oldTag,
                showCancelButton: true,
                customClass: {
                    input: 'swal-wide-input'
                },
                didOpen: () => {
                    // å¼·åˆ¶ä¿®æ­£ SweetAlert2 è¼¸å…¥æ¡†å¯¬åº¦å•é¡Œ
                    const input = Swal.getInput();
                    if (input) {
                        input.style.width = '100%';
                        input.style.boxSizing = 'border-box';
                        input.style.margin = '10px 0';
                    }
                },
                inputValidator: (value) => {
                    if (!value || value.trim() === '') return 'è«‹è¼¸å…¥æ–°åç¨±';
                    if (value.trim() === oldTag) return 'åç¨±æ²’æœ‰è®Šå‹•';
                }
            });

            if (newTag) {
                const password = localStorage.getItem('admin_password');
                Swal.fire({ title: 'æ¨™ç±¤æ›´ååŒæ­¥ä¸­...', didOpen: () => Swal.showLoading() });

                const res = await fetchAPI('renameTopicTag', { oldName: oldTag, newName: newTag.trim(), password });
                if (res && res.status === "success") {
                    showModal('æ›´åæˆåŠŸ', `å·²æ›´æ–° ${res.updatedCount} å‰‡æ­·å²ç•™è¨€çš„æ¨™ç±¤åç¨±ã€‚`, 'success');
                    loadTopicConfig();
                    loadAdminMessages();
                } else {
                    Swal.close();
                }
            }
        }

        function addTopicToLibrary() {
            const input = document.getElementById('new-topic-tag-input');
            let tag = input.value.trim();
            if (!tag) return;
            if (!tag.startsWith('#')) tag = '#' + tag;

            const library = topicConfig.library ? topicConfig.library.split('\n').map(t => t.trim()).filter(t => t) : [];
            if (library.includes(tag)) {
                showModal('æç¤º', 'æ­¤æ¨™ç±¤å·²å­˜åœ¨æ¨™ç±¤åº«ä¸­', 'info');
                return;
            }

            library.push(tag);
            topicConfig.library = library.join('\n');
            input.value = '';
            renderTopicManagementUI();
        }

        function removeTopicFromLibrary(tag) {
            Swal.fire({
                title: 'ç¢ºå®šåˆªé™¤ï¼Ÿ',
                text: `å°‡æ¨™ç±¤ ${tag} å¾æ¨™ç±¤åº«ç§»é™¤`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'ç¢ºå®š',
                cancelButtonText: 'å–æ¶ˆ'
            }).then((result) => {
                if (result.isConfirmed) {
                    const library = topicConfig.library.split('\n').map(t => t.trim()).filter(t => t !== tag);
                    topicConfig.library = library.join('\n');

                    // åŒæ­¥ç§»é™¤ active/default ä¸­çš„è©²æ¨™ç±¤
                    const active = topicConfig.activeSubmissionTags.split(',').map(t => t.trim()).filter(t => t && t !== tag);
                    const defWall = topicConfig.defaultWallTags.split(',').map(t => t.trim()).filter(t => t && t !== tag);
                    topicConfig.activeSubmissionTags = active.join(', ');
                    topicConfig.defaultWallTags = defWall.join(', ');

                    renderTopicManagementUI();
                }
            });
        }

        function applyTopicConfig() {
            const submissionWrapper = document.getElementById('topic-tag-wrapper');
            const pillsContainer = document.getElementById('topic-pills-container');
            const hiddenInput = document.getElementById('topicTag');

            if (topicConfig.activeSubmissionTags) {
                const tags = topicConfig.activeSubmissionTags.split(',').map(t => t.trim()).filter(t => t);
                if (tags.length > 0) {
                    pillsContainer.innerHTML = '';

                    // æ–°å¢ã€Œä¸æŒ‡å®šã€é¸é …
                    const resetBtn = document.createElement('div');
                    resetBtn.className = 'tag-pill active';
                    resetBtn.textContent = 'ç„¡æ¨™ç±¤';
                    resetBtn.onclick = () => selectTopicTag('', resetBtn);
                    pillsContainer.appendChild(resetBtn);
                    hiddenInput.value = '';

                    tags.forEach(tag => {
                        const pill = document.createElement('div');
                        pill.className = 'tag-pill';
                        pill.textContent = tag;
                        pill.onclick = () => selectTopicTag(tag, pill);
                        pillsContainer.appendChild(pill);
                    });

                    submissionWrapper.style.display = 'flex';
                    submissionWrapper.style.flexDirection = 'column';
                    submissionWrapper.style.gap = '0.5rem';
                } else {
                    submissionWrapper.style.display = 'none';
                }
                loadMessages();
            } else {
                submissionWrapper.style.display = 'none';
            }
        }

        function selectTopicTag(tag, element) {
            document.getElementById('topicTag').value = tag;
            document.querySelectorAll('#topic-pills-container .tag-pill').forEach(pill => {
                pill.classList.remove('active');
            });
            element.classList.add('active');
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showModal('å·²è¤‡è£½', 'ç¶²å€å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿', 'success');
            });
        }
        async function loadTopicConfig() {
            const res = await fetchAPI('getTopicConfig');
            if (res && !res.error) {
                topicConfig = res;
                applyTopicConfig();
            }
        }
    </script>

    <!-- ç”¨æ–¼æä¾›çµ¦ä½¿ç”¨è€…è¤‡è£½çš„ç¯„æœ¬ -->
</body>

</html>
