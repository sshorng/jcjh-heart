<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å»ºæˆå¿ƒèƒ½é‡</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Outfit:wght@400;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- SweetAlert2 for beautiful modals -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root {
            --primary-coral: #f27979;
            /* è¼•ç·‹ç´… */
            --soft-cream: #fffafb;
            /* åç²‰çš„å¥¶ç™½è‰² */
            --glass-bg: rgba(255, 255, 255, 0.65);
            --glass-border: rgba(255, 255, 255, 0.4);
            --font-main: 'Outfit', 'Noto Sans TC', sans-serif;
            --card-shadow: 0 10px 40px rgba(107, 79, 79, 0.05);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: var(--font-main);
        }

        body {
            font-family: var(--font-main);
            background: #fff9f5;
            margin: 0;
            min-height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            color: #2d3436;
        }

        /* å·”å³°è³ªæ„Ÿï¼šæµé«”å‹•æ…‹æ¼¸å±¤èƒŒæ™¯ */
        .ambient-glow {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #fff9f5;
            z-index: -1;
            overflow: hidden;
        }

        .ambient-glow::before,
        .ambient-glow::after {
            content: '';
            position: absolute;
            width: 80vmax;
            height: 80vmax;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.15;
            z-index: -1;
            animation: drift 25s infinite alternate ease-in-out;
        }

        .ambient-glow::before {
            background: radial-gradient(circle, #ff8e8e 0%, transparent 70%);
            /* ç·‹ç´…å…‰ */
            top: -20%;
            left: -10%;
        }

        .ambient-glow::after {
            background: radial-gradient(circle, #f2a3a3 0%, transparent 70%);
            /* æŸ”ç²‰å…‰ */
            bottom: -20%;
            right: -10%;
            animation-duration: 35s;
            animation-delay: -5s;
        }

        @keyframes drift {
            0% {
                transform: translate(0, 0) scale(1) rotate(0deg);
            }

            50% {
                transform: translate(10%, 15%) scale(1.1) rotate(10deg);
            }

            100% {
                transform: translate(-5%, -10%) scale(1) rotate(-5deg);
            }
        }

        header {
            padding: 1.5rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 300;
            /* é«˜æ–¼å¡ç‰‡ç‰† */
            position: relative;
        }

        .header-content {
            background: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            padding: 0.8rem 1.8rem;
            border-radius: 40px;
            border: 1px solid var(--glass-border);
            display: flex;
            align-items: center;
            gap: 1.2rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.03);
        }

        .logo-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #f27979 0%, #ffb3b3 100%);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
            box-shadow: 0 8px 20px rgba(242, 121, 121, 0.3);
        }

        .logo-text h1 {
            font-size: 1.2rem;
            font-weight: 700;
            margin: 0;
            letter-spacing: 1px;
            color: var(--primary-coral);
        }

        .logo-text p {
            font-size: 0.75rem;
            margin: 0;
            opacity: 0.6;
        }

        .header-actions {
            display: none;
        }

        /* æ•´åˆå¼åŠŸèƒ½å€çµ„ä»¶ */
        .fab-container {
            position: fixed;
            bottom: 2.5rem;
            right: 2.5rem;
            z-index: 50;
            /* èª¿ä½ z-index è®“å¡ç‰‡èƒ½é®æ“‹ */
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .fab-qr-wrapper {
            background: rgba(255, 255, 255, 0.45);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            padding: 10px;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .fab-qr-wrapper:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.7);
        }

        .fab-qr-img {
            width: 110px;
            height: 110px;
            display: block;
            border-radius: 8px;
            mix-blend-mode: multiply;
            /* è®“ QR Code æ›´èåˆèƒŒæ™¯ */
            opacity: 0.85;
        }

        .admin-entry button {
            background: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid var(--glass-border);
            border-radius: 50%;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            color: #636e72;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        }

        .admin-entry button:hover {
            background: rgba(255, 255, 255, 0.6);
            color: var(--primary-coral);
            transform: translateY(-2px);
        }

        /* ç•™è¨€å±•ç¤ºå€ */
        #messageBoard {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 200;
            /* é«˜æ–¼æŒ‰éˆ•ï¼Œè®“å¡ç‰‡èƒ½é®æ“‹åŠŸèƒ½å€ */
            pointer-events: none;
        }

        /* é ‚ç´šè³ªæ„Ÿï¼šé«˜ç´šç´™è³ªèˆ‡ç´™è† å¸¶å¡ç‰‡ */
        .message-card {
            background: #fffdf9;
            background-image:
                radial-gradient(#e5e5e5 0.5px, transparent 0.5px),
                linear-gradient(rgba(255, 255, 255, 0.8), rgba(255, 255, 255, 0.2));
            background-size: 20px 20px, 100% 100%;
            border-radius: 12px;
            padding: 2.22rem;
            padding-top: 3.2rem;
            width: 340px;
            min-height: 220px;
            box-shadow:
                0 15px 45px rgba(139, 90, 43, 0.08),
                0 5px 15px rgba(139, 90, 43, 0.03);
            position: absolute;
            display: flex;
            flex-direction: column;
            gap: 1.2rem;
            will-change: transform, opacity;
            transition: all 0.6s cubic-bezier(0.23, 1, 0.32, 1);
            border: none;
            z-index: 100;
            /* é«˜æ–¼æŒ‰éˆ•å€åŸŸ */
            pointer-events: auto;
        }

        /* é«˜å“è³ªå’Œç´™è† å¸¶ - æ•´é½Šåˆ‡é‚Š */
        .message-card::before {
            content: '';
            position: absolute;
            top: -12px;
            left: 50%;
            transform: translateX(-50%) rotate(0.5deg);
            width: 100px;
            height: 32px;
            background: rgba(255, 220, 180, 0.5);
            backdrop-filter: blur(4px);
            z-index: 5;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
            /* å’Œç´™çº–ç¶­ç´‹ç† */
            background-image:
                linear-gradient(90deg, rgba(255, 255, 255, 0.1) 1px, transparent 1px),
                linear-gradient(rgba(255, 255, 255, 0.1) 1px, transparent 1px);
            background-size: 4px 4px;
        }

        .message-card:hover {
            transform: translateY(-12px) rotate(var(--rot, 0deg)) scale(1.03) !important;
            box-shadow: 0 30px 70px rgba(139, 90, 43, 0.12);
            z-index: 400 !important;
            /* äº’å‹•æ™‚çµ•å°ç½®é ‚ */
        }

        /* æ¨™é¡Œæ•´åˆæ–¼ç´™å¼µä¸­ */
        .card-greeting {
            color: #b07d62;
            font-size: 1rem;
            font-weight: 700;
            padding-bottom: 8px;
            border-bottom: 1.5px solid rgba(176, 125, 98, 0.15);
            width: fit-content;
        }

        .card-content {
            font-size: var(--font-size, 1.4rem);
            line-height: 1.55;
            font-weight: 400;
            color: #4a3e3e;
            flex: 1;
            padding-right: 0;
            overflow: visible;
            /* è¢å¹•æ’­æ”¾ä¸ä½¿ç”¨æ»¾å‹• */
        }

        /* éš±è—åŸç”Ÿæ»¾å‹•æ¢ï¼Œæ”¹ç”¨æ¥µç´°ç¾åŒ–ç‰ˆ */
        .card-content::-webkit-scrollbar {
            width: 3px;
        }

        .card-content::-webkit-scrollbar-thumb {
            background: rgba(176, 125, 98, 0.2);
            border-radius: 10px;
        }

        /* å­—ç´šç¸®æ”¾é¡åˆ¥ - é‡å°è¢å¹•æ’­æ”¾å„ªåŒ– */
        .size-large {
            --font-size: 1.65rem;
        }

        .size-medium {
            --font-size: 1.35rem;
        }

        .size-small {
            --font-size: 1.15rem;
        }

        .card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 1px solid rgba(0, 0, 0, 0.05);
            padding-top: 1.2rem;
        }

        .card-author {
            color: #636e72;
            font-size: 0.85rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .card-tag {
            font-size: 0.75rem;
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        /* è«è˜­è¿ªå’Œè«§è‰²æ¨™ç±¤ */
        .card-tag {
            font-size: 0.75rem;
            padding: 5px 14px;
            border-radius: 8px;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        .tag-é¼“å‹µ {
            background: #d4e2d4;
            color: #4a7c59;
        }

        .tag-è®šç¾ {
            background: #f0e4d7;
            color: #b08968;
        }

        .tag-é—œå¿ƒ {
            background: #e3d5ca;
            color: #7f5539;
        }

        .tag-æ„Ÿè¬ {
            background: #dfd3c3;
            color: #8d7b70;
        }

        .tag-ç¥ç¦ {
            background: #f5ebe0;
            color: #d4a373;
        }

        /* ç²¾ç·»æŒ‰éˆ• */
        .card-like {
            position: absolute;
            top: 2rem;
            right: 2rem;
            background: #fff0f0;
            /* æ·ºç²‰è‰²èƒŒæ™¯ */
            border: 1px solid #ffdada;
            /* ç²‰è‰²é‚Šæ¡† */
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--primary-coral);
            /* æ„›å¿ƒé¡è‰² */
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(242, 121, 121, 0.1);
            z-index: 10;
        }

        .card-like:hover {
            transform: scale(1.1);
            background: #ffe5e5;
        }

        .card-like.liked {
            background: #ffdada;
            /* æŒ‰è®šå¾Œé¡è‰²åŠ æ·±ä¸€é» */
        }

        .like-count {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ff6b6b;
            color: white;
            font-size: 0.65rem;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: 800;
        }

        /* æ‡¸æµ®æŒ‰éˆ•åŸå§‹ä½ç½® CSS å·²ç”± .fab-container æ¥ç®¡ */

        .fab {
            background: linear-gradient(135deg, #f27979 0%, #faa6a6 100%);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 30px;
            font-weight: 700;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 0.8rem;
            cursor: pointer;
            box-shadow: 0 15px 35px rgba(242, 121, 121, 0.3);
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .fab:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 20px 45px rgba(255, 138, 113, 0.5);
        }

        .fab i {
            font-size: 1rem;
        }

        .pulsate {
            animation: pulsate 1.5s infinite;
        }

        @keyframes pulsate {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }

            100% {
                transform: scale(1);
            }
        }

        /* å‹•ç•«æ•ˆæœ */
        @keyframes fadeIn {
            0% {
                opacity: 0;
                transform: rotate(var(--rot, 0deg)) translateY(20px) scale(0.95);
            }

            100% {
                opacity: 1;
                transform: rotate(var(--rot, 0deg)) translateY(0) scale(1);
            }
        }

        @keyframes fadeOut {
            0% {
                opacity: 1;
                transform: rotate(var(--rot, 0deg));
            }

            100% {
                opacity: 0;
                transform: rotate(var(--rot, 0deg)) translateY(-15px) scale(0.95);
            }
        }

        .animate-float {
            animation: fadeIn 0.6s ease-out forwards;
        }

        .animate-float.fade-out {
            animation: fadeOut 0.8s ease-out forwards;
        }


        .admin-trigger {
            position: fixed;
            bottom: 5px;
            right: 5px;
            width: 20px;
            height: 20px;
            opacity: 0.05;
            cursor: pointer;
            z-index: 400;
        }

        .admin-trigger:hover {
            opacity: 0.3;
        }

        /* Modal è¦†è“‹å±¤ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(107, 79, 79, 0.3);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }

        .modal-content {
            background: var(--soft-cream);
            padding: 2rem;
            border-radius: 20px;
            width: 95%;
            max-width: 800px;
            /* å¢åŠ å¯¬åº¦ä»¥é©æ‡‰ç®¡ç†ä»‹é¢ */
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            border: 1px solid rgba(232, 153, 141, 0.3);
            box-shadow: 0 20px 60px rgba(107, 79, 79, 0.15);
            z-index: 1001;
        }

        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            cursor: pointer;
            font-size: 1.5rem;
            color: #636e72;
            opacity: 0.5;
            transition: opacity 0.2s;
        }

        .modal-close:hover {
            opacity: 1;
        }

        form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        label {
            font-weight: bold;
            margin-bottom: 0.2rem;
            color: #4e342e;
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 0.8rem;
            border-radius: 8px;
            border: 1px solid #ddd;
            font-family: inherit;
            font-size: 1rem;
            color: #4e342e;
            box-sizing: border-box;
            /* ç¢ºä¿ padding ä¸æœƒæ’ç ´å¯¬åº¦ */
        }

        button.btn-submit {
            background: linear-gradient(135deg, var(--primary-coral) 0%, #d4a373 100%);
            color: white;
            border: none;
            padding: 1rem;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            box-shadow: 0 4px 12px rgba(232, 153, 141, 0.3);
            transition: all 0.3s ease;
        }

        button.btn-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(232, 153, 141, 0.4);
        }


        /* ç®¡ç†è€…ä»‹é¢å°ˆå±¬ */
        .admin-tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            border-bottom: 1px solid #ddd;
            padding-bottom: 0.5rem;
        }

        .tab-btn {
            padding: 8px 16px;
            cursor: pointer;
            border-radius: 4px;
            border: 1px solid transparent;
            font-weight: bold;
            color: #636e72;
        }

        .tab-btn.active {
            background: var(--primary-coral);
            color: white;
        }


        .admin-list {
            list-style: none;
            max-height: 50vh;
            overflow-y: auto;
        }

        .batch-actions {
            margin-bottom: 1rem;
            display: flex;
            gap: 0.5rem;
            align-items: center;
            flex-wrap: wrap;
            background: rgba(232, 153, 141, 0.1);
            padding: 0.6rem 1rem;
            border-radius: 8px;
            font-size: 0.85rem;
        }

        .admin-item {
            background: white;
            margin-bottom: 0.5rem;
            padding: 0.6rem 1rem;
            border-radius: 6px;
            border: 1px solid #eee;
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: 0.85rem;
        }

        .admin-item:hover {
            background: #fefefe;
            border-color: var(--primary-coral);
        }

        .admin-item .item-checkbox {
            flex-shrink: 0;
        }

        .admin-item .item-info {
            flex: 1;
            min-width: 0;
        }

        .admin-item .item-meta {
            font-size: 0.75rem;
            color: #999;
            margin-bottom: 2px;
        }

        .admin-item .item-content {
            word-break: break-all;
            white-space: normal;
            /* å…è¨±æ›è¡Œ */
            color: #4a3e3e;
            margin: 5px 0;
            line-height: 1.4;
        }

        .admin-item .item-target {
            font-weight: 600;
            color: var(--primary-coral);
        }

        .admin-actions {
            display: flex;
            gap: 0.3rem;
            flex-shrink: 0;
        }

        .btn-approve {
            background: #27ae60;
            color: white;
            border: none;
            padding: 4px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .btn-reject {
            background: #c0392b;
            color: white;

            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
        }

        @media (max-width: 600px) {
            h1 {
                font-size: 1.8rem;
            }

            #messageBoard {
                padding: 1rem;
            }

            .message-card {
                width: 100%;
                position: relative !important;
                opacity: 1 !important;
                transform: none !important;
                animation: none !important;
            }

            .fab-container {
                bottom: 1.5rem;
                right: 1.5rem;
            }

            .fab {
                padding: 0.8rem 1.5rem;
                font-size: 1rem;
            }

            header {
                padding: 1rem;
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .header-content {
                width: 100%;
                justify-content: center;
            }

            .header-actions {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>

<body>
    <div class="ambient-glow"></div>

    <header>
        <div class="header-content">
            <div class="logo-icon">ğŸŒ¸</div>
            <div class="logo-text">
                <h1>å»ºæˆå¿ƒèƒ½é‡</h1>
                <p>Digital Floating Message Gallery</p>
            </div>
        </div>
    </header>

    <div id="messageBoard"></div>

    <!-- æ•´åˆå¼åŠŸèƒ½çƒï¼šQR + å¯«ç•™è¨€ -->
    <div class="fab-container">
        <div class="fab-qr-wrapper" onclick="openPostModal()" title="æƒç¢¼äº¦å¯ç•™è¨€">
            <img id="fabQrImg" class="fab-qr-img" src="" alt="QR">
        </div>
        <button class="fab" onclick="openPostModal()">
            <i class="fas fa-feather-alt pulsate"></i>
            <span>å¯«ç•™è¨€</span>
        </button>
    </div>

    <!-- å³ä¸‹è§’éš±è—å…¥å£ -->
    <div class="admin-trigger" onclick="openAdminModal()"></div>


    <!-- éš±è—çš„å¾Œç«¯å…¥å£ -->
    <!-- <div class="admin-trigger" onclick="openAdminModal()"></div> -->

    <!-- ç•™è¨€ Modal -->
    <div id="postModal" class="modal-overlay" onclick="if(event.target === this) closeModal('postModal')">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('postModal')">&times;</span>
            <h2 style="color: var(--warm-coral); text-align: center; margin-bottom: 1.5rem;">
                æŠ•ç¨¿æº«æš–</h2>
            <form id="postForm">
                <!-- æº«é¦¨æé†’ -->
                <div
                    style="background: linear-gradient(135deg, #fff9e6 0%, #fff0f5 100%); padding: 1rem; border-radius: 12px; margin-bottom: 1rem; border-left: 4px solid var(--warm-coral);">
                    <p style="font-size: 0.85rem; color: var(--warm-brown); margin: 0; line-height: 1.6;">
                        ğŸ’ <strong>æŠ•ç¨¿å°æé†’</strong><br>
                        â€¢ è«‹ç”¨æ­£å‘ã€æº«æš–çš„æ–‡å­—å‚³éå¿ƒæ„<br>
                        â€¢ ç•™è¨€å°‡ç¶“è€å¸«å¯©æ ¸å¾Œå…¬é–‹é¡¯ç¤º<br>
                        â€¢ ç³»çµ±æœƒè¨˜éŒ„å¸³è™Ÿï¼Œè«‹æ„›è­·æ ¡åœ’å‹å–„ç’°å¢ƒ
                    </p>
                </div>

                <label>å°èª°èªªè©±ï¼Ÿ</label>
                <input type="text" id="target" placeholder="ä¾‹å¦‚ï¼š701 å…¨é«”åŒå­¸ã€ç‹è€å¸«..." required>

                <label>æ¨™ç±¤</label>
                <select id="tag">
                    <option value="é¼“å‹µ">ğŸ’ª é¼“å‹µ</option>
                    <option value="è®šç¾">âœ¨ è®šç¾</option>
                    <option value="é—œå¿ƒ">ğŸ«‚ é—œå¿ƒ</option>
                    <option value="æ„Ÿè¬">ğŸ‚ æ„Ÿè¬</option>
                    <option value="ç¥ç¦">ğŸˆ ç¥ç¦</option>
                </select>

                <label>ç•™è¨€å…§å®¹</label>
                <div style="position: relative;">
                    <textarea id="content" rows="4" placeholder="å¯«ä¸‹ä½ çš„å¿ƒæ„ (120å­—ä»¥å…§)..." required maxlength="120"
                        oninput="updateCharCount()"></textarea>
                    <div id="charCount"
                        style="position: absolute; bottom: 10px; right: 10px; font-size: 0.75rem; color: #999; pointer-events: none;">
                        0 / 120</div>
                </div>

                <div
                    style="display: flex; align-items: center; gap: 0.8rem; margin-top: 0.5rem; background: rgba(139, 90, 43, 0.04); padding: 0.8rem; border-radius: 10px; border: 1px dashed rgba(139, 90, 43, 0.1);">
                    <div style="display: flex; align-items: center; gap: 0.4rem; white-space: nowrap;">
                        <input type="checkbox" id="isAnonymous" style="width: 18px; height: 18px; cursor: pointer;"
                            onchange="toggleAnonymousName()">
                        <label for="isAnonymous" style="margin: 0; font-weight: 600; cursor: pointer;">åŒ¿åç•™è¨€</label>
                    </div>
                    <div id="anonymousNameWrapper" style="display: none; flex: 1; min-width: 0;">
                        <input type="text" id="anonymousName"
                            style="width: 100%; padding: 6px 12px; font-size: 0.9rem; border: 1px solid #ddd; border-radius: 6px; background: white;"
                            placeholder="è‡ªè¨‚æš±ç¨± (é è¨­: å°å¤©ä½¿)" maxlength="10">
                    </div>
                </div>


                <div id="google-login-container"
                    style="margin-top: 1rem; text-align: center; position: relative; z-index: 1002;">
                    <p style="font-size: 0.85rem; margin-bottom: 0.5rem; color: #666;">* ç³»çµ±å°‡è¨˜éŒ„æ‚¨çš„ Google å¸³è™Ÿä»¥åˆ©ç¶­è­·ç’°å¢ƒç§©åº</p>
                    <!-- Google Login Button Placeholder -->
                    <div id="g_id_onload"
                        data-client_id="236765538215-6o3ol1tl1brqhbd2qfavomq38l7j17aq.apps.googleusercontent.com"
                        data-context="signin" data-ux_mode="popup" data-callback="handleCredentialResponse"
                        data-auto_prompt="false" style="z-index: 2000;">
                    </div>
                    <div class="g_id_signin" data-type="standard" data-shape="rectangular" data-theme="outline"
                        data-text="signin_with" data-size="large" data-logo_alignment="left" style="z-index: 2000;">
                    </div>
                </div>

                <button type="button" class="btn-submit" onclick="submitDraft()">é€å‡ºç•™è¨€ (è«‹å…ˆç™»å…¥)</button>
            </form>

        </div>
    </div>

    <!-- ç®¡ç†è€…ä»‹é¢ Modal (åˆä½µè¨­å®š) -->
    <div id="adminModal" class="modal-overlay" onclick="if(event.target === this) closeModal('adminModal')">
        <div class="modal-content" style="max-width: 800px; width: 95%;">
            <span class="modal-close" onclick="closeModal('adminModal')">&times;</span>
            <h2 style="color: var(--warm-brown); text-align: center; margin-bottom: 1rem;">ç®¡ç†å¾Œå°</h2>

            <!-- API é€£ç·šè¨­å®š (æ‘ºç–Šå¼) -->
            <details id="admin-setup-ui" style="border-bottom: 1px solid rgba(0,0,0,0.06); margin-bottom: 1rem;">
                <summary
                    style="cursor: pointer; padding: 10px; color: var(--primary-coral); font-weight: 600; font-size: 0.9rem;">
                    âš™ï¸ API é€£ç·šèˆ‡åˆ†äº«è¨­å®š (åˆæ¬¡ä½¿ç”¨æˆ–æ›´æ›è³‡æ–™åº«æ™‚é»é–‹)
                </summary>
                <div style="padding: 10px; background: rgba(0,0,0,0.02); border-radius: 10px; margin-bottom: 1rem;">
                    <label style="font-size: 0.85rem;">GAS Web App URL (éƒ¨ç½²å¾Œçš„ç¶²å€)</label>
                    <div style="display: flex; gap: 10px; margin-top: 0.5rem;">
                        <input type="password" id="gasUrl" style="flex: 1;" placeholder="è²¼å…¥ GAS ç¶²å€...">
                        <button class="btn-submit" style="padding: 0 15px; font-size: 0.85rem;"
                            onclick="saveSettings()">å„²å­˜</button>
                    </div>
                    <div style="margin-top: 10px; display: flex; gap: 10px;">
                        <button class="btn-submit"
                            style="background: #95a5a6; flex: 1; padding: 8px; font-size: 0.75rem;"
                            onclick="clearSettings()">é‡è¨­é€£ç·š</button>
                        <button class="btn-submit"
                            style="background: #8e44ad; flex: 1; padding: 8px; font-size: 0.75rem;"
                            onclick="openInfoModal()">éƒ¨ç½²æ•™å­¸</button>
                        <button class="btn-submit"
                            style="background: #27ae60; flex: 1; padding: 8px; font-size: 0.75rem;"
                            onclick="generateShareLink()">ç”¢ç”Ÿåˆ†äº«é€£çµ</button>
                    </div>

                    <!-- åˆ†äº«é€£çµé¡¯ç¤ºå€ (é è¨­éš±è—) -->
                    <div id="share-link-area"
                        style="display:none; margin-top: 15px; padding: 15px; background: white; border-radius: 10px; border: 1px solid #eee; text-align: center;">
                        <p style="font-size: 0.8rem; color: #666; margin-bottom: 10px;">åˆ†äº«æ­¤é€£çµçµ¦å…¶ä»–ç®¡ç†è€…ï¼Œæˆ–ç”±æ‰‹æ©Ÿæƒç¢¼å¿«é€Ÿé…ç½®ï¼š</p>
                        <div id="shareQrContainer" style="margin-bottom: 10px;">
                            <img id="shareQrImg"
                                style="width: 150px; height: 150px; border: 1px solid #eee; padding: 5px;">
                        </div>
                        <div style="display: flex; gap: 5px;">
                            <input type="text" id="shareUrlDisplay" readonly
                                style="flex: 1; font-size: 0.75rem; padding: 5px;">
                            <button class="btn-submit" style="padding: 5px 10px; font-size: 0.75rem;"
                                onclick="copyShareUrl()">è¤‡è£½é€£çµ</button>
                        </div>
                    </div>
                </div>
            </details>

            <div id="admin-management-ui" style="margin-top: 2rem;">
                <h3 style="font-size: 1rem; margin-bottom: 1rem; color: #b07d62;">2. ç•™è¨€å…§å®¹ç®¡ç†</h3>

                <div id="admin-login-ui">
                    <p style="font-size: 0.85rem; color: #8d7b70; margin-bottom: 10px;">è«‹è¼¸å…¥å¯†ç¢¼è§£é–ç®¡ç†å“¡æ¬Šé™</p>
                    <div style="display: flex; gap: 10px;">
                        <input type="password" id="adminPassword" placeholder="ç®¡ç†å¯†ç¢¼" style="flex: 1;">
                        <button class="btn-submit" style="padding: 0 20px;" onclick="doAdminLogin()">è§£é–</button>
                    </div>
                </div>

                <div id="admin-panel" style="display:none; margin-top: 1rem;">
                    <div class="admin-tabs">
                        <div class="tab-btn active" onclick="switchTab('å¾…å¯©æ ¸')">å¾…å¯©æ ¸</div>
                        <div class="tab-btn" onclick="switchTab('é€šé')">å·²é€šé</div>
                        <div class="tab-btn" onclick="switchTab('é§å›')">å·²é§å›</div>
                    </div>

                    <div id="tab-content-list" class="tab-pane">
                        <div class="batch-actions" id="batch-actions-bar">
                            <input type="checkbox" id="selectAll" onchange="toggleSelectAll(this)"
                                style="width:20px; height:20px;">
                            <label for="selectAll">å…¨é¸</label>
                            <button class="btn-approve" onclick="batchUpdate('é€šé')">æ‰¹æ¬¡é€šé</button>
                            <button class="btn-reject" onclick="batchUpdate('é§å›')">æ‰¹æ¬¡é§å›</button>
                        </div>
                        <ul id="admin-msg-list" class="admin-list"></ul>
                    </div>
                </div>
            </div>

            <div style="text-align: right; margin-top: 1rem;">
                <button onclick="logoutAdmin()"
                    style="font-size: 0.8rem; border:none; background:none; text-decoration: underline; color: #999; cursor:pointer;">ç™»å‡ºç®¡ç†å“¡èº«åˆ†</button>
            </div>
        </div>
    </div>
    </div>

    <!-- èªªæ˜ Modal -->
    <div id="infoModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 800px;">
            <span class="modal-close" onclick="closeModal('infoModal')">&times;</span>
            <h3>â„¹ï¸ éƒ¨ç½²èªªæ˜</h3>
            <div style="margin-top: 1rem; font-size: 0.9rem; line-height: 1.6;">
                <ol>
                    <li>åœ¨ <b>Google è©¦ç®—è¡¨</b>ä¸­ï¼Œé»æ“Šã€Œæ“´å……åŠŸèƒ½ã€> ã€ŒApps Scriptã€ã€‚</li>
                    <li>å°‡å¾Œæ–¹æä¾›çš„ä»£ç¢¼è²¼å…¥ï¼Œä¸¦å„²å­˜ã€‚</li>
                    <li>é»åŠã€Œéƒ¨ç½²ã€>ã€Œæ–°å¢éƒ¨ç½²ã€ã€‚é¸å–ã€Œç¶²é æ‡‰ç”¨ç¨‹å¼ã€ã€‚</li>
                    <li>åŸ·è¡Œèº«åˆ†ï¼š<b>æˆ‘</b>ï¼Œèª°å¯ä»¥å­˜å–ï¼š<b>æ‰€æœ‰äºº</b>ã€‚</li>
                    <li>è¤‡è£½éƒ¨ç½²å¾Œçš„ç¶²å€ï¼Œå›åˆ°æ­¤é é¢é»æ“Š âš™ï¸ å¡«å…¥ã€‚</li>
                </ol>
            </div>
            <h4 style="margin-top: 1.5rem;">GAS å¾Œç«¯åŸå§‹ç¢¼</h4>
            <div style="position: relative;">
                <button style="position: absolute; right: 0; top: -30px; padding: 5px 10px; cursor:pointer;"
                    onclick="copyGasCode()">ğŸ“‹ è¤‡è£½ä»£ç¢¼</button>
                <textarea id="gas-code-view" readonly
                    style="width: 100%; height: 200px; font-family: monospace; font-size: 0.8rem; background: #eee;"></textarea>
            </div>
        </div>
    </div>

    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script>
        // --- è¨­å®šèˆ‡è®Šæ•¸ ---
        const DEFAULT_GAS_URL = ""; // å¦‚æœè¦å›ºå®šç¶²å€ï¼Œè«‹å¡«å…¥æ­¤è™•
        let currentUserEmail = null;
        let currentUserName = null;
        let allMessages = [];
        let usedIndexes = new Set(); // ç”¨æ–¼è¿½è¹¤å·²é¡¯ç¤ºçš„ç•™è¨€ç´¢å¼•
        let likedMessages = JSON.parse(localStorage.getItem('liked_messages') || '[]'); // å·²æŒ‰è®šçš„ç•™è¨€ ID

        // æ•æ„Ÿè©æ¸…å–®ï¼ˆå¯è‡ªè¡Œæ“´å……ï¼‰
        const SENSITIVE_WORDS = [
            'ç¬¨è›‹', 'ç™½ç™¡', 'å»æ­»', 'æ™ºéšœ', 'å»¢ç‰©', 'åƒåœ¾', 'æ»¾', 'çˆ›',
            'å¹¹', 'é ', 'åª½çš„', 'ä»–åª½', 'å±', 'è³¤', 'å©Š', 'æ¸£',
            'fuck', 'shit', 'damn', 'bitch', 'stupid', 'idiot'
        ];

        // --- æ•æ„Ÿè©æª¢æ¸¬ ---
        function containsSensitiveWords(text) {
            const lowerText = text.toLowerCase();
            return SENSITIVE_WORDS.some(word => lowerText.includes(word.toLowerCase()));
        }

        // --- å„ªå…ˆé †åºé‚è¼¯ ---
        function getGasUrl() {
            // å·²åœ¨ window.onload è™•ç†éç¶²å€åƒæ•¸ï¼Œæ­¤è™•ç›´æ¥è®€å– localStorage å³å¯
            return localStorage.getItem('gas_url') || DEFAULT_GAS_URL;
        }

        // --- åˆå§‹åŒ–é é¢ ---
        window.onload = () => {
            const urlParams = new URLSearchParams(window.location.search);

            // å„ªå…ˆæª¢æŸ¥ç¶²å€åƒæ•¸æ˜¯å¦æœ‰ config (è‡ªå‹•é€£ç·šè¨­å®š)
            if (urlParams.has('config')) {
                try {
                    const encodedUrl = urlParams.get('config');
                    const decodedUrl = atob(encodedUrl);
                    if (decodedUrl.startsWith('https://script.google.com')) {
                        localStorage.setItem('gas_url', decodedUrl);
                        showModal('è¨­å®šæˆåŠŸ', 'å·²é€éåˆ†äº«é€£çµè‡ªå‹•å®Œæˆ API é…ç½®', 'success');
                        window.history.replaceState({}, document.title, window.location.pathname);
                    }
                } catch (e) {
                    console.error("Config URL decoding failed", e);
                }
            }

            const url = getGasUrl();
            if (url) {
                loadMessages();
                setInterval(loadMessages, 30000);
            } else {
                openAdminModal();
                Swal.fire({
                    title: 'åˆå§‹åŒ–è¨­å®š',
                    text: 'è«‹å…ˆåœ¨ã€Œ1. API é€£ç·šè¨­å®šã€å¡«å…¥æ‚¨çš„ GAS éƒ¨ç½²ç¶²å€',
                    icon: 'info'
                });
            }

            // ç”Ÿæˆæ•´åˆå¼ QR Code
            let currentUrl = window.location.origin;
            if (currentUrl === "null") { // è™•ç† file:// å”è­°
                currentUrl = window.location.href.split('?')[0];
            } else {
                currentUrl = window.location.origin + window.location.pathname;
            }

            const writeUrl = `${currentUrl}?write=true`;
            if (document.getElementById('fabQrImg')) {
                // å¦‚æœæ˜¯æœ¬åœ°æª”æ¡ˆï¼Œåœ¨ console çµ¦äºˆè­¦å‘Šæç¤ºï¼Œä¸¦ç¢ºä¿ QR Code æ˜¯é»‘è‰²çš„æé«˜å°æ¯”åº¦
                const isLocal = window.location.protocol === 'file:';
                if (isLocal) console.warn("åµæ¸¬åˆ°æœ¬åœ°æª”æ¡ˆåŸ·è¡Œã€‚QR Code å°‡åŒ…å«æœ¬åœ°è·¯å¾‘ï¼Œæ‰‹æ©Ÿæƒæå°‡ç„¡æ³•è·¨è£ç½®è®€å–ã€‚");

                document.getElementById('fabQrImg').src = `https://quickchart.io/qr?text=${encodeURIComponent(writeUrl)}&size=150&margin=0&dark=f27979&light=ffffff`;
            }

            // é—œéµåŠŸèƒ½ï¼šæƒç¢¼å³å¯«æª¢æ¸¬
            if (urlParams.has('write')) {
                setTimeout(openPostModal, 1500);
            }

            setInterval(rotateMessages, 2000);
        };


        // --- åˆ‡æ›åŒ¿åæš±ç¨±è¼¸å…¥ ---
        function toggleAnonymousName() {
            const wrapper = document.getElementById('anonymousNameWrapper');
            const checkbox = document.getElementById('isAnonymous');
            wrapper.style.display = checkbox.checked ? 'block' : 'none';
        }

        // --- æ„›å¿ƒæŒ‰è®š ---
        async function toggleLike(msgId, btn) {
            const isLiked = likedMessages.includes(msgId);
            const increment = isLiked ? -1 : 1;

            // æ›´æ–°æœ¬åœ°ç‹€æ…‹
            if (isLiked) {
                likedMessages = likedMessages.filter(id => id !== msgId);
                btn.classList.remove('liked');
            } else {
                likedMessages.push(msgId);
                btn.classList.add('liked');
            }

            localStorage.setItem('liked_messages', JSON.stringify(likedMessages));

            // æ›´æ–° UI ä¸Šçš„è¨ˆæ•¸ (æ›´ç©©å¥çš„é¸å–æ–¹å¼)
            let countEl = btn.querySelector('.like-count');
            if (!countEl) {
                // å¦‚æœåŸæœ¬æ²’æœ‰è¨ˆæ•¸æ¨™ç±¤ï¼Œå‹•æ…‹å‰µå»ºä¸€å€‹
                countEl = document.createElement('span');
                countEl.className = 'like-count';
                btn.appendChild(countEl);
            }

            let count = parseInt(countEl.textContent) || 0;
            count = Math.max(0, count + increment);
            countEl.textContent = count > 0 ? count : '';

            // åŒæ­¥åˆ°å¾Œç«¯
            await fetchAPI('toggleLike', null, { id: msgId, increment: increment });
        }




        // --- API ä¸²æ¥ ---
        async function fetchAPI(action, data = null, params = null) {
            const url = getGasUrl();
            if (!url) {
                showModal('éŒ¯èª¤', 'æœªè¨­å®š GAS ç¶²å€', 'error');
                return null;
            }

            try {
                // ä¿®æ­£é‚è¼¯ï¼šåˆ¤æ–·å“ªäº›è¡Œå‹•æ‡‰è©²ä½¿ç”¨ POST
                const isPost = (action === 'submitMessage' || action === 'updateStatus');

                const options = {
                    method: isPost ? 'POST' : 'GET',
                    mode: 'cors'
                };

                let targetUrl = url;
                if (!isPost) {
                    // å…¨é¢ä¿®å¾©ï¼šæ‰€æœ‰ GET è«‹æ±‚éƒ½å¿…é ˆåŒ…å« action èˆ‡åƒæ•¸
                    targetUrl += `?action=${action}`;
                    if (params) {
                        for (let k in params) targetUrl += `&${k}=${encodeURIComponent(params[k])}`;
                    }
                } else {
                    // POST è«‹æ±‚ï¼šå°‡è³‡æ–™èˆ‡è¡Œå‹•åŒ…è£åœ¨ Body
                    options.body = JSON.stringify({ ...data, action });
                }

                const response = await fetch(targetUrl, options);
                const result = await response.json();

                if (result.error) {
                    showModal('API è¨Šæ¯', result.error, 'warning');
                    return null;
                }
                return result;
            } catch (err) {
                console.error(err);
                showModal('é€£ç·šå¤±æ•—', 'ç„¡æ³•èˆ‡æœå‹™ç«¯é€šè¨Šï¼Œè«‹æª¢æŸ¥ç¶²å€æ˜¯å¦æ­£ç¢ºã€‚', 'error');
                return null;
            }
        }

        // --- æ ¸å¿ƒåŠŸèƒ½ï¼šè®€å–ç•™è¨€ ---
        async function loadMessages() {
            const board = document.getElementById('messageBoard');
            const result = await fetchAPI('getMessages');
            if (result && !result.error) {
                allMessages = result;
                if (allMessages.length === 0) {
                    board.innerHTML = '<div style="opacity:0.5;">ç›®å‰é‚„æ²’æœ‰æº«æš–çš„ç•™è¨€ï¼Œå¿«ä¾†å¯«ç¬¬ä¸€å‰‡å§ï¼</div>';
                } else {
                    board.innerHTML = '';
                    // åˆå§‹æ™‚ä¸ç«‹å³é¡¯ç¤ºï¼Œè®“ rotateMessages é€æ­¥æ·»åŠ 
                }
            }
        }

        // --- æ ¸å¿ƒåŠŸèƒ½ï¼šéš¨æ©Ÿæ—‹è½‰ç•™è¨€å¡ç‰‡ ---
        let displayingIndexes = new Set(); // è¿½è¹¤ç•¶å‰æ­£åœ¨ç•«é¢ä¸Šçš„å¡ç‰‡

        function rotateMessages() {
            if (allMessages.length === 0) return;

            const board = document.getElementById('messageBoard');
            if (!board) return;
            const boardWidth = board.clientWidth;
            const boardHeight = board.clientHeight;

            // èª¿æ•´å…±å­˜å¡ç‰‡æ•¸é‡
            const maxOnScreen = Math.min(window.innerWidth < 600 ? 3 : 6, allMessages.length);
            const currentCards = board.querySelectorAll('.message-card');

            if (currentCards.length < maxOnScreen) {
                // å°‹æ‰¾ä¸€å€‹ä¸åœ¨ç•«é¢ä¸Šçš„ç´¢å¼•
                let availableIndexes = [];
                for (let i = 0; i < allMessages.length; i++) {
                    if (!displayingIndexes.has(i)) {
                        availableIndexes.push(i);
                    }
                }

                if (availableIndexes.length === 0) return; // æ‰€æœ‰ç•™è¨€éƒ½åœ¨ç•«é¢ä¸Šäº†

                const randomPick = availableIndexes[Math.floor(Math.random() * availableIndexes.length)];
                displayingIndexes.add(randomPick);
                createCard(allMessages[randomPick], boardWidth, boardHeight, randomPick);

            }
        }

        // é è¨ˆç®—ä½ç½®ï¼ˆæ›´è‡ªç„¶çš„æ•£ä½ˆï¼‰
        let gridPositions = [];
        let positionIndex = 0;

        function calculateGridPositions() {
            gridPositions = [];
            const bw = window.innerWidth;
            const bh = window.innerHeight;
            const cardW = 340;
            const cardH = 260; // ç¨å¾®å¢åŠ é ä¼°é«˜åº¦

            // è¨­å®šé‚Šç•Œå®‰å…¨ç¯„åœ (é¿å…è²¼é‚Šæˆ–è¶…å‡º)
            const margin = 30;
            const availableW = bw - (margin * 2);
            const availableH = bh - (margin * 2); // ç§»é™¤ä¸‹æ–¹é ç•™ç©ºé–“ï¼Œå…è¨±å¡ç‰‡è¦†è“‹æŒ‰éˆ•

            const cols = Math.max(1, Math.floor(availableW / (cardW + 20)));
            const rows = Math.max(1, Math.floor(availableH / (cardH + 20)));

            const gapX = cols > 1 ? (availableW - cols * cardW) / (cols - 1) : 0;
            const gapY = rows > 1 ? (availableH - rows * cardH) / (rows - 1) : 0;

            for (let r = 0; r < rows; r++) {
                for (let c = 0; c < cols; c++) {
                    const startX = (bw - (cols * cardW + (cols - 1) * gapX)) / 2;
                    const startY = margin + 40;

                    gridPositions.push({
                        x: startX + c * (cardW + gapX) + (Math.random() - 0.5) * 30,
                        y: startY + r * (cardH + gapY) + (Math.random() - 0.5) * 30,
                        rot: (Math.random() - 0.5) * 8
                    });
                }
            }
            gridPositions.sort(() => Math.random() - 0.5);
        }


        function createCard(msg, bw, bh, index) {
            const board = document.getElementById('messageBoard');
            const card = document.createElement('div');
            card.className = 'message-card animate-float';

            // ä½¿ç”¨ç¶²æ ¼ä½ç½®ä¸¦åŠ å…¥ç‰©ç†å®‰å…¨æª¢æŸ¥
            if (gridPositions.length === 0 || positionIndex >= gridPositions.length) {
                calculateGridPositions();
                positionIndex = 0;
            }
            const pos = gridPositions[positionIndex];
            positionIndex++;

            // å®‰å…¨é™åˆ¶ï¼šç¢ºä¿ left/top ä¸æœƒè®“å¡ç‰‡è¶…å‡º
            const safeX = Math.max(20, Math.min(pos.x, window.innerWidth - 360));
            const safeY = Math.max(80, Math.min(pos.y, window.innerHeight - 300));

            card.style.setProperty('--rot', `${pos.rot}deg`);
            card.style.setProperty('--tape-rot', `${(Math.random() - 0.5) * 8}deg`);
            card.style.top = `${safeY}px`;
            card.style.left = `${safeX}px`;

            // æª¢æŸ¥æ˜¯å¦å·²æŒ‰è®š
            const isLiked = likedMessages.includes(msg.id);
            const heartIcon = isLiked ? 'fas fa-heart' : 'far fa-heart';
            const likedClass = isLiked ? 'liked' : '';

            // éš¨æ©Ÿè† å¸¶ä½ç½®é‚è¼¯
            const tapePos = Math.random() > 0.5 ? '20px' : '230px';
            const tapeRot = (Math.random() * 20 - 10) + (tapePos === '20px' ? -15 : 15);
            card.style.setProperty('--tape-pos', tapePos);
            card.style.setProperty('--tape-rot', tapeRot + 'deg');

            // --- å¤§è¢å¹•å­—ç´šå„ªåŒ–é‹ç®— ---
            const contentLen = msg.content.length;
            let sizeClass = "size-small";
            if (contentLen < 40) sizeClass = "size-large";
            else if (contentLen < 80) sizeClass = "size-medium";

            card.innerHTML = `
                <div class="card-greeting">è‡´ï¼š${msg.target}</div>
                <div class="card-content ${sizeClass}">${msg.content}</div>
                <div class="card-footer">
                    <div class="card-tag tag-${msg.tag}">${msg.tag}</div>
                    <div class="card-author">${msg.displayName}</div>
                </div>
                <button class="card-like ${likedClass}" onclick="toggleLike('${msg.id}', this)" title="é€ä»–ä¸€å€‹å¿ƒ">
                    <i class="fas fa-heart"></i>
                    ${msg.likes > 0 ? `<span class="like-count">${msg.likes}</span>` : ''}
                </button>
            `;








            board.appendChild(card);

            // éš¨æ©Ÿå‹•ç•«å»¶é²
            card.style.animationDelay = `0s, ${Math.random() * 2}s`;


            // 12ç§’å¾Œç§»é™¤
            setTimeout(() => {
                card.classList.add('fade-out');
                setTimeout(() => {
                    card.remove();
                    displayingIndexes.delete(index);
                }, 1000);
            }, 11000);
        }



        // --- Google ç™»å…¥è™•ç† ---
        function handleCredentialResponse(response) {
            const payload = parseJwt(response.credential);
            const email = payload.email;
            const domain = "@stweb.jcjh.tp.edu.tw";

            if (!email.endsWith(domain)) {
                showModal('ç¶²åŸŸéŒ¯èª¤', `æŠ±æ­‰ï¼Œæœ¬ç•™è¨€æ¿åƒ…é™å»ºæˆåœ‹ä¸­å­¸ç”Ÿå¸³è™Ÿ (${domain}) ä½¿ç”¨ã€‚`, 'error');
                return;
            }

            currentUserEmail = email;
            currentUserName = payload.name;

            const loginContainer = document.getElementById('google-login-container');
            loginContainer.innerHTML = `<p style="color: #27ae60; font-weight: bold;">âœ… å·²èªè­‰ï¼š${currentUserName}</p>`;

            document.querySelector('.btn-submit[onclick="submitDraft()"]').textContent = "ç¢ºèªé€å‡ºç•™è¨€";
        }

        function parseJwt(token) {
            var base64Url = token.split('.')[1];
            var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            var jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function (c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            return JSON.parse(jsonPayload);
        }

        // --- é€å‡ºç•™è¨€ ---
        async function submitDraft() {
            if (!currentUserEmail) {
                showModal('æç¤º', 'è«‹å…ˆä½¿ç”¨ Google å¸³è™Ÿç™»å…¥ï¼Œä»¥ç¶­è­·æ ¡åœ’ç•™è¨€ç’°å¢ƒã€‚', 'warning');
                return;
            }

            const content = document.getElementById('content').value;
            const target = document.getElementById('target').value;

            // æ•æ„Ÿè©æª¢æ¸¬
            if (containsSensitiveWords(content) || containsSensitiveWords(target)) {
                showModal('å…§å®¹ä¸ç•¶', 'æ‚¨çš„ç•™è¨€åŒ…å«ä¸æ°ç•¶çš„ç”¨èªï¼Œè«‹ä¿®æ”¹å¾Œé‡æ–°é€å‡ºã€‚è®“æˆ‘å€‘ä¸€èµ·ç¶­è­·å‹å–„çš„æ ¡åœ’ç’°å¢ƒ ğŸ’', 'warning');
                return;
            }

            const isAnonymous = document.getElementById('isAnonymous').checked;
            const anonymousName = document.getElementById('anonymousName')?.value?.trim() || '';

            const data = {
                target: target,
                tag: document.getElementById('tag').value,
                content: content,
                isAnonymous: isAnonymous,
                anonymousName: isAnonymous ? (anonymousName || 'å°å¤©ä½¿') : '',
                email: currentUserEmail,
                name: currentUserName
            };

            if (!data.target || !data.content) {
                showModal('å¡«å¯«æœªå®Œæˆ', 'è«‹å¡«å¯«ç•™è¨€å°è±¡èˆ‡å…§å®¹ã€‚', 'warning');
                return;
            }

            const btn = document.querySelector('.btn-submit[onclick="submitDraft()"]');
            btn.disabled = true;
            btn.textContent = "å‚³é€ä¸­...";

            const res = await fetchAPI('submitMessage', data);

            if (res && res.status === "success") {
                showModal('é€å‡ºæˆåŠŸ', res.message, 'success');
                closeModal('postModal');
                document.getElementById('postForm').reset();
            } else {
                showModal('å¤±æ•—', 'ç•™è¨€é€å‡ºå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ã€‚', 'error');
            }

            btn.disabled = false;
            btn.textContent = "ç¢ºèªé€å‡ºç•™è¨€";
        }

        // --- ç®¡ç†å¾Œå°è™•ç† ---
        let adminRawData = [];
        let currentTab = "å¾…å¯©æ ¸";

        async function doAdminLogin() {
            const password = document.getElementById('adminPassword').value;
            const res = await fetchAPI('adminGetMessages', null, { password });

            if (res && !res.error) {
                sessionStorage.setItem('admin_password', password); // è¨˜æ†¶ç™»å…¥ç‹€æ…‹ (session)
                renderAdminUI(res);
            } else {
                showModal('éŒ¯èª¤', 'å¯†ç¢¼ä¸æ­£ç¢ºã€‚', 'error');
            }
        }

        function renderAdminUI(data) {
            adminRawData = data;
            document.getElementById('admin-login-ui').style.display = 'none';
            document.getElementById('admin-panel').style.display = 'block';
            switchTab(currentTab);
        }

        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab-btn').forEach(b => {
                b.classList.toggle('active', b.textContent === tab);
            });

            const list = document.getElementById('admin-msg-list');
            list.innerHTML = '';
            document.getElementById('batch-actions-bar').style.display = (tab === 'å¾…å¯©æ ¸') ? 'flex' : 'none';

            const filtered = adminRawData.filter(m => m.status === tab);
            if (filtered.length === 0) {
                list.innerHTML = `<li style="text-align:center; padding: 2rem; color: #999;">ç›®å‰æ²’æœ‰${tab}çš„ç•™è¨€ã€‚</li>`;
                return;
            }

            filtered.forEach(m => {
                const li = document.createElement('li');
                li.className = 'admin-item';
                const dateStr = new Date(m.timestamp).toLocaleString('zh-TW', { month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                li.innerHTML = `
                    <input type="checkbox" class="msg-checkbox item-checkbox" value="${m.id}">
                    <div class="item-info">
                        <div class="item-meta">${dateStr} Â· <span class="item-target">${m.target}</span> Â· ${m.tag}</div>
                        <div class="item-content">${m.content}</div>
                        <div style="font-size:0.75rem; color:#888; margin-top:2px;">
                            é¡¯ç¤ºï¼š${m.displayName} ï½œ çœŸå¯¦ï¼š${m.realName || 'ä¸å…·å'}ï¼ˆ${m.account}ï¼‰
                        </div>

                    </div>
                    <div class="admin-actions">
                        ${m.status !== 'é€šé' ? `<button class="btn-approve" onclick="updateStatus('${m.id}', 'é€šé')">âœ“</button>` : ''}
                        ${m.status !== 'é§å›' ? `<button class="btn-reject" onclick="updateStatus('${m.id}', 'é§å›')">âœ—</button>` : ''}
                    </div>
                `;
                list.appendChild(li);
            });
        }


        async function batchUpdate(status) {
            const checkboxes = document.querySelectorAll('.msg-checkbox:checked');
            const ids = Array.from(checkboxes).map(cb => cb.value);
            if (ids.length === 0) {
                showModal('æç¤º', 'è«‹å…ˆå‹¾é¸è¦è™•ç†çš„ç•™è¨€ã€‚', 'info');
                return;
            }

            const password = sessionStorage.getItem('admin_password');
            let successCount = 0;

            Swal.fire({ title: 'æ‰¹æ¬¡è™•ç†ä¸­...', allowOutsideClick: false, didOpen: () => { Swal.showLoading(); } });

            for (const id of ids) {
                const res = await fetchAPI('updateStatus', { id, status, password });
                if (res && res.status === "success") successCount++;
            }

            Swal.close();
            showModal('å®Œæˆ', `å·²æˆåŠŸè™•ç† ${successCount} å‰‡ç•™è¨€ã€‚`, 'success');
            loadAdminMessages(); // é‡æ–°æ•´ç†è³‡æ–™
            loadMessages(); // å‰å°æ›´æ–°
        }

        async function loadAdminMessages() {
            const password = sessionStorage.getItem('admin_password');
            if (!password) return;
            const res = await fetchAPI('adminGetMessages', null, { password });
            if (res && !res.error) {
                adminRawData = res;
                switchTab(currentTab);
            }
        }

        function logoutAdmin() {
            sessionStorage.removeItem('admin_password');
            location.reload();
        }

        function toggleSelectAll(source) {
            const checkboxes = document.querySelectorAll('.msg-checkbox');
            checkboxes.forEach(cb => cb.checked = source.checked);
        }

        async function updateStatus(id, newStatus) {
            const password = sessionStorage.getItem('admin_password');
            const res = await fetchAPI('updateStatus', { id, status: newStatus, password });
            if (res && res.status === "success") {
                loadAdminMessages();
                loadMessages();
            }
        }

        // --- è¨­å®šèˆ‡å·¥å…· ---
        // --- è¨­å®šèˆ‡å·¥å…· ---
        async function saveSettings() {
            const url = document.getElementById('gasUrl').value.trim();
            if (!url.startsWith('https://script.google.com')) {
                showModal('éŒ¯èª¤', 'è«‹è¼¸å…¥æ­£ç¢ºçš„ GAS Web App ç¶²å€', 'error');
                return;
            }
            localStorage.setItem('gas_url', url);

            // å˜—è©¦åˆå§‹åŒ–å¾Œç«¯
            const btn = document.querySelector('button[onclick="saveSettings()"]');
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = "æ­£åœ¨è¯çµ¡å¾Œç«¯...";

            try {
                const res = await fetchAPI('init');
                if (res && (res.status === "success" || res.status === "ok")) {
                    showModal('æˆåŠŸ', 'é€£ç·šè¨­å®šå·²å„²å­˜ä¸”è³‡æ–™åº«å·²åˆå§‹åŒ–', 'success');
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showModal('è­¦å‘Š', 'è¨­å®šå·²å„²å­˜ï¼Œä½†å¾Œç«¯åˆå§‹åŒ–å›æ‡‰ç•°å¸¸ã€‚è«‹ç¢ºèªæ‚¨çš„ GAS éƒ¨ç½²æ¬Šé™ã€‚', 'warning');
                    setTimeout(() => location.reload(), 3000);
                }
            } catch (e) {
                showModal('æˆåŠŸ', 'é€£ç·šè¨­å®šå·²å„²å­˜', 'success');
                setTimeout(() => location.reload(), 1500);
            }

            btn.disabled = false;
            btn.textContent = originalText;
        }

        function generateShareLink() {
            const url = getGasUrl();
            if (!url || url === "" || url === DEFAULT_GAS_URL) {
                showModal('æç¤º', 'è«‹å…ˆå¡«å…¥ä¸¦å„²å­˜è‡ªè¨‚çš„ GAS ç¶²å€å¾Œå†ç”¢ç”Ÿåˆ†äº«é€£çµ', 'info');
                return;
            }

            const area = document.getElementById('share-link-area');
            const baseUrl = window.location.href.split('?')[0];
            const configFullUrl = `${baseUrl}?config=${btoa(url)}`;

            // é¡¯ç¤ºå€åŸŸ
            area.style.display = 'block';
            document.getElementById('shareUrlDisplay').value = configFullUrl;

            // ç”Ÿæˆ QR Code (å°æ‡‰åˆ†äº«é€£çµ)
            const qrImg = document.getElementById('shareQrImg');
            if (qrImg) {
                qrImg.src = `https://quickchart.io/qr?text=${encodeURIComponent(configFullUrl)}&size=200&dark=f27979`;
            }

            showModal('åˆ†äº«é€£çµå·²ç”¢ç”Ÿ', 'æ‚¨ç¾åœ¨å¯ä»¥è¤‡è£½é€£çµæˆ–é€é QR Code åˆ†äº«è¨­å®š', 'success');
        }

        function copyShareUrl() {
            const input = document.getElementById('shareUrlDisplay');
            input.select();
            document.execCommand('copy');
            showModal('æˆåŠŸ', 'åˆ†äº«é€£çµå·²è¤‡è£½', 'success');
        }

        function clearSettings() {
            Swal.fire({
                title: 'ç¢ºå®šé‡ç½®ï¼Ÿ',
                text: 'é€™å°‡åˆªé™¤æœ¬åœ°çš„ GAS é€£ç·šç´€éŒ„',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'ç¢ºå®šåˆªé™¤',
                cancelButtonText: 'å–æ¶ˆ'
            }).then((result) => {
                if (result.isConfirmed) {
                    localStorage.removeItem('gas_url');
                    localStorage.removeItem('admin_token');
                    location.reload();
                }
            });
        }

        // --- é€šç”¨ UI å‡½å¼ ---
        function showModal(title, message, type = 'info') {
            Swal.fire({
                title,
                text: message,
                icon: type,
                confirmButtonColor: '#e67e22'
            });
        }

        function openPostModal() { document.getElementById('postModal').style.display = 'flex'; }
        function openSettingsModal() {
            document.getElementById('gasUrl').value = getGasUrl();
            document.getElementById('settingsModal').style.display = 'flex';
        }
        function openAdminModal() { document.getElementById('adminModal').style.display = 'flex'; }
        function openInfoModal() {
            document.getElementById('infoModal').style.display = 'flex';
            // è®€å–ç›®å‰çš„ç¨‹å¼ç¢¼ä¾›è¤‡è£½
            const code = `// é€™è£¡æœƒæ”¾ç½®å¾Œç«¯ Code.gs çš„å…§å®¹ï¼Œæ–¹ä¾¿ä½¿ç”¨è€…è¤‡è£½`;
            document.getElementById('gas-code-view').value = document.querySelector('#gas-code-template')?.textContent || "è«‹å¾ Code.gs æª”æ¡ˆä¸­è¤‡è£½ç¨‹å¼ç¢¼ã€‚";
        }

        function closeModal(id) { document.getElementById(id).style.display = 'none'; }

        function updateCharCount() {
            const content = document.getElementById('content').value;
            document.getElementById('charCount').textContent = `${content.length} / 120`;
        }

        function copyGasCode() {
            const textarea = document.getElementById('gas-code-view');
            textarea.select();
            document.execCommand('copy');
            showModal('æˆåŠŸ', 'ç¨‹å¼ç¢¼å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿', 'success');
        }
    </script>

    <!-- ç”¨æ–¼æä¾›çµ¦ä½¿ç”¨è€…è¤‡è£½çš„ç¯„æœ¬ -->
</body>

</html>